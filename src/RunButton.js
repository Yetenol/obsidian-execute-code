import { MarkdownView } from 'obsidian';
import { supportedLanguages } from './main';
import { Outputter } from './output/Outputter';
import { CodeInjector } from './transforms/CodeInjector';
import { retrieveFigurePath } from './transforms/LatexFigureName';
import { modifyLatexCode } from './transforms/LatexTransformer';
import * as macro from './transforms/Magic';
import { getLanguageAlias } from './transforms/TransformCode';
const buttonText = "Run";
export const buttonClass = "run-code-button";
export const disabledClass = "run-button-disabled";
export const codeBlockHasButtonClass = "has-run-code-button";
/**
 * Handles the execution of code blocks based on the selected programming language.
 * Injects any required code, transforms the source if needed, and manages button state.
 * @param block Contains context needed for execution including source code, output handler, and UI elements
 */
async function handleExecution(block) {
    const language = block.language;
    const button = block.button;
    const srcCode = block.srcCode;
    const app = block.outputter.app;
    const s = block.outputter.settings;
    button.className = disabledClass;
    block.srcCode = await new CodeInjector(app, s, language).injectCode(srcCode);
    switch (language) {
        case "js": return runCode(s.nodePath, s.nodeArgs, s.jsFileExtension, block, { transform: (code) => macro.expandJS(code) });
        case "java": return runCode(s.javaPath, s.javaArgs, s.javaFileExtension, block);
        case "python": return runCode(s.pythonPath, s.pythonArgs, s.pythonFileExtension, block, { transform: (code) => macro.expandPython(code, s) });
        case "shell": return runCode(s.shellPath, s.shellArgs, s.shellFileExtension, block, { shell: true });
        case "batch": return runCode(s.batchPath, s.batchArgs, s.batchFileExtension, block, { shell: true });
        case "powershell": return runCode(s.powershellPath, s.powershellArgs, s.powershellFileExtension, block, { shell: true });
        case "cpp": return runCode(s.clingPath, `-std=${s.clingStd} ${s.clingArgs}`, s.cppFileExtension, block);
        case "prolog":
            runCode("", "", "", block);
            button.className = buttonClass;
            break;
        case "groovy": return runCode(s.groovyPath, s.groovyArgs, s.groovyFileExtension, block, { shell: true });
        case "rust": return runCode(s.cargoPath, "eval" + s.cargoEvalArgs, s.rustFileExtension, block);
        case "r": return runCode(s.RPath, s.RArgs, s.RFileExtension, block, { transform: (code) => macro.expandRPlots(code) });
        case "go": return runCode(s.golangPath, s.golangArgs, s.golangFileExtension, block);
        case "kotlin": return runCode(s.kotlinPath, s.kotlinArgs, s.kotlinFileExtension, block, { shell: true });
        case "ts": return runCode(s.tsPath, s.tsArgs, "ts", block, { shell: true });
        case "lua": return runCode(s.luaPath, s.luaArgs, s.luaFileExtension, block, { shell: true });
        case "dart": return runCode(s.dartPath, s.dartArgs, s.dartFileExtension, block, { shell: true });
        case "cs": return runCode(s.csPath, s.csArgs, s.csFileExtension, block, { shell: true });
        case "haskell": return (s.useGhci)
            ? runCode(s.ghciPath, "", "hs", block, { shell: true })
            : runCode(s.runghcPath, "-f " + s.ghcPath, "hs", block, { shell: true });
        case "mathematica": return runCode(s.mathematicaPath, s.mathematicaArgs, s.mathematicaFileExtension, block, { shell: true });
        case "scala": return runCode(s.scalaPath, s.scalaArgs, s.scalaFileExtension, block, { shell: true });
        case "swift": return runCode(s.swiftPath, s.swiftArgs, s.swiftFileExtension, block, { shell: true });
        case "c": return runCode(s.clingPath, s.clingArgs, "c", block, { shell: true });
        case "ruby": return runCode(s.rubyPath, s.rubyArgs, s.rubyFileExtension, block, { shell: true });
        case "sql": return runCode(s.sqlPath, s.sqlArgs, "sql", block, { shell: true });
        case "octave": return runCode(s.octavePath, s.octaveArgs, s.octaveFileExtension, block, { shell: true, transform: (code) => macro.expandOctavePlot(code) });
        case "maxima": return runCode(s.maximaPath, s.maximaArgs, s.maximaFileExtension, block, { shell: true, transform: (code) => macro.expandMaximaPlot(code) });
        case "racket": return runCode(s.racketPath, s.racketArgs, s.racketFileExtension, block, { shell: true });
        case "applescript": return runCode(s.applescriptPath, s.applescriptArgs, s.applescriptFileExtension, block, { shell: true });
        case "zig": return runCode(s.zigPath, s.zigArgs, "zig", block, { shell: true });
        case "ocaml": return runCode(s.ocamlPath, s.ocamlArgs, "ocaml", block, { shell: true });
        case "php": return runCode(s.phpPath, s.phpArgs, s.phpFileExtension, block, { shell: true });
        case "latex":
            const outputPath = await retrieveFigurePath(block.srcCode, s.latexFigureTitlePattern, block.markdownFile, s);
            const invokeCompiler = [s.latexTexfotArgs, s.latexCompilerPath, s.latexCompilerArgs].join(" ");
            return (!s.latexDoFilter)
                ? runCode(s.latexCompilerPath, s.latexCompilerArgs, outputPath, block, { transform: (code) => modifyLatexCode(code, s) })
                : runCode(s.latexTexfotPath, invokeCompiler, outputPath, block, { transform: (code) => modifyLatexCode(code, s) });
        default: break;
    }
}
/**
 * Adds run buttons to code blocks in all currently open Markdown files.
 * More efficient than scanning entire documents since it only processes visible content.
 * @param plugin Contains context needed for execution.
 */
export function addInOpenFiles(plugin) {
    const workspace = plugin.app.workspace;
    workspace.iterateRootLeaves(leaf => {
        if (leaf.view instanceof MarkdownView) {
            addToAllCodeBlocks(leaf.view.contentEl, leaf.view.file.path, leaf.view, plugin);
        }
    });
}
/**
 * Add a button to each code block that allows the user to run the code. The button is only added if the code block
 * utilizes a language that is supported by this plugin.
 * @param element The parent element (i.e. the currently showed html page / note).
 * @param file An identifier for the currently showed note
 * @param view The current markdown view
 * @param plugin Contains context needed for execution.
*/
export function addToAllCodeBlocks(element, file, view, plugin) {
    Array.from(element.getElementsByTagName("code"))
        .forEach((codeBlock) => addToCodeBlock(codeBlock, file, view, plugin));
}
/**
 * Processes a code block to add execution capabilities. Ensures buttons aren't duplicated on already processed blocks.
 * @param codeBlock The code block element to process
 * @param file Path to the current markdown file
 * @param view The current markdown view
 * @param plugin Contains context needed for execution.
 */
function addToCodeBlock(codeBlock, file, view, plugin) {
    if (codeBlock.className.match(/^language-\{\w+/i)) {
        codeBlock.className = codeBlock.className.replace(/^language-\{(\w+)/i, "language-$1 {");
        codeBlock.parentElement.className = codeBlock.className;
    }
    const language = codeBlock.className.toLowerCase();
    if (!language || !language.contains("language-"))
        return;
    const pre = codeBlock.parentElement;
    const parent = pre.parentElement;
    const srcCode = codeBlock.getText();
    let sanitizedClassList = sanitizeClassListOfCodeBlock(codeBlock);
    const canonicalLanguage = getLanguageAlias(supportedLanguages.find(lang => sanitizedClassList.contains(`language-${lang}`)));
    const isLanguageSupported = canonicalLanguage !== undefined;
    const hasBlockBeenButtonifiedAlready = parent.classList.contains(codeBlockHasButtonClass);
    if (!isLanguageSupported || hasBlockBeenButtonifiedAlready)
        return;
    const outputter = new Outputter(codeBlock, plugin.settings, view, plugin.app, file);
    parent.classList.add(codeBlockHasButtonClass);
    const button = createButton();
    pre.appendChild(button);
    const block = {
        srcCode: srcCode,
        language: canonicalLanguage,
        markdownFile: file,
        button: button,
        outputter: outputter,
        executors: plugin.executors,
    };
    button.addEventListener("click", () => handleExecution(block));
}
/**
 * Normalizes language class names to ensure consistent processing.
 * @param codeBlock - The code block element whose classes need to be sanitized
 * @returns Array of normalized class names
 */
function sanitizeClassListOfCodeBlock(codeBlock) {
    let sanitizedClassList = Array.from(codeBlock.classList);
    return sanitizedClassList.map(c => c.toLowerCase());
}
/**
 * Creates a new run button and returns it.
 */
function createButton() {
    console.debug("Add run button");
    const button = document.createElement("button");
    button.classList.add(buttonClass);
    button.setText(buttonText);
    return button;
}
/**
 * Executes the code with the given command and arguments. The code is written to a temporary file and then executed.
 * The output of the code is displayed in the output panel ({@link Outputter}).
 * If the code execution fails, an error message is displayed and logged.
 * After the code execution, the temporary file is deleted and the run button is re-enabled.
 * @param cmd The command that should be used to execute the code. (e.g. python, java, ...)
 * @param cmdArgs Additional arguments that should be passed to the command.
 * @param ext The file extension of the temporary file. Should correspond to the language of the code. (e.g. py, ...)
 * @param block Contains context needed for execution including source code, output handler, and UI elements
 */
function runCode(cmd, cmdArgs, ext, block, options) {
    const useShell = (options === null || options === void 0 ? void 0 : options.shell) ? options.shell : false;
    if (options === null || options === void 0 ? void 0 : options.transform)
        block.srcCode = options.transform(block.srcCode);
    if (!useShell)
        block.outputter.startBlock();
    const executor = block.executors.getExecutorFor(block.markdownFile, block.language, useShell);
    executor.run(block.srcCode, block.outputter, cmd, cmdArgs, ext).then(() => {
        block.button.className = buttonClass;
        if (!useShell) {
            block.outputter.closeInput();
            block.outputter.finishBlock();
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUnVuQnV0dG9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUnVuQnV0dG9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBa0IsWUFBWSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRXhELE9BQU8sRUFBNkIsa0JBQWtCLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdkUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRS9DLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDaEUsT0FBTyxLQUFLLEtBQUssTUFBTSxvQkFBb0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFFekIsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFXLGlCQUFpQixDQUFDO0FBQ3JELE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBVyxxQkFBcUIsQ0FBQztBQUMzRCxNQUFNLENBQUMsTUFBTSx1QkFBdUIsR0FBVyxxQkFBcUIsQ0FBQztBQVdyRTs7OztHQUlHO0FBQ0gsS0FBSyxVQUFVLGVBQWUsQ0FBQyxLQUF1QjtJQUNsRCxNQUFNLFFBQVEsR0FBZSxLQUFLLENBQUMsUUFBUSxDQUFDO0lBQzVDLE1BQU0sTUFBTSxHQUFzQixLQUFLLENBQUMsTUFBTSxDQUFDO0lBQy9DLE1BQU0sT0FBTyxHQUFXLEtBQUssQ0FBQyxPQUFPLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQVEsS0FBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7SUFDckMsTUFBTSxDQUFDLEdBQXFCLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBRXJELE1BQU0sQ0FBQyxTQUFTLEdB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QUVEOzs7Ozs7Ozs7R0FTRztBQUNILFNBQVMsT0FBTyxDQUFDLEdBQVcsRUFBRSxPQUFlLEVBQUUsR0FBVyxFQUFFLEtBQXVCLEVBQUUsT0FBb0U7SUFDckosTUFBTSxRQUFRLEdBQVksQ0FBQyxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUNuRSxJQUFJLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxTQUFTO1FBQUUsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6RSxJQUFJLENBQUMsUUFBUTtRQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLENBQUM7SUFFNUMsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlGLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUN0RSxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxXQUFXLENBQUM7UUFDckMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNYLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDN0IsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNqQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgV29ya3NwYWNlLCBNYXJrZG93blZpZXcgfSBmcm9tICdvYnNpZGlhbic7XHJcbmltcG9ydCBFeGVjdXRvckNvbnRhaW5lciBmcm9tICcuL0V4ZWN1dG9yQ29udGFpbmVyJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VJZCwgUGx1Z2luQ29udGV4dCwgc3VwcG9ydGVkTGFuZ3VhZ2VzIH0gZnJvbSAnLi9tYWluJztcclxuaW1wb3J0IHsgT3V0cHV0dGVyIH0gZnJvbSAnLi9vdXRwdXQvT3V0cHV0dGVyJztcclxuaW1wb3J0IHR5cGUgeyBFeGVjdXRvclNldHRpbmdzIH0gZnJvbSAnLi9zZXR0aW5ncy9TZXR0aW5ncyc7XHJcbmltcG9ydCB7IENvZGVJbmplY3RvciB9IGZyb20gJy4vdHJhbnNmb3Jtcy9Db2RlSW5qZWN0b3InO1xyXG5pbXBvcnQgeyByZXRyaWV2ZUZpZ3VyZVBhdGggfSBmcm9tICcuL3RyYW5zZm9ybXMvTGF0ZXhGaWd1cmVOYW1lJztcclxuaW1wb3J0IHsgbW9kaWZ5TGF0ZXhDb2RlIH0gZnJvbSAnLi90cmFuc2Zvcm1zL0xhdGV4VHJhbnNmb3JtZXInO1xyXG5pbXBvcnQgKiBhcyBtYWNybyBmcm9tICcuL3RyYW5zZm9ybXMvTWFnaWMnO1xyXG5pbXBvcnQgeyBnZXRMYW5ndWFnZUFsaWFzIH0gZnJvbSAnLi90cmFuc2Zvcm1zL1RyYW5zZm9ybUNvZGUnO1xyXG5cclxuY29uc3QgYnV0dG9uVGV4dCA9IFwiUnVuXCI7XHJcblxyXG5leHBvcnQgY29uc3QgYnV0dG9uQ2xhc3M6IHN0cmluZyA9IFwicnVuLWNvZGUtYnV0dG9uXCI7XHJcbmV4cG9ydCBjb25zdCBkaXNhYmxlZENsYXNzOiBzdHJpbmcgPSBcInJ1bi1idXR0b24tZGlzYWJsZWRcIjtcclxuZXhwb3J0IGNvbnN0IGNvZGVCbG9ja0hhc0J1dHRvbkNsYXNzOiBzdHJpbmcgPSBcImhhcy1ydW4tY29kZS1idXR0b25cIjtcclxuXHJcbmludGVyZmFjZSBDb2RlQmxvY2tDb250ZXh0IHtcclxuICAgIHNyY0NvZGU6IHN0cmluZztcclxuICAgIGJ1dHRvbjogSFRNTEJ1dHRvbkVsZW1lbnQ7XHJcbiAgICBsYW5ndWFnZTogTGFuZ3VhZ2VJZDtcclxuICAgIG1hcmtkb3duRmlsZTogc3RyaW5nO1xyXG4gICAgb3V0cHV0dGVyOiBPdXRwdXR0ZXI7XHJcbiAgICBleGVjdXRvcnM6IEV4ZWN1dG9yQ29udGFpbmVyO1xyXG59XHJcblxyXG4vKipcclxuICogSGFuZGxlcyB0aGUgZXhlY3V0aW9uIG9mIGNvZGUgYmxvY2tzIGJhc2VkIG9uIHRoZSBzZWxlY3RlZCBwcm9ncmFtbWluZyBsYW5ndWFnZS5cclxuICogSW5qZWN0cyBhbnkgcmVxdWlyZWQgY29kZSwgdHJhbnNmb3JtcyB0aGUgc291cmNlIGlmIG5lZWRlZCwgYW5kIG1hbmFnZXMgYnV0dG9uIHN0YXRlLlxyXG4gKiBAcGFyYW0gYmxvY2sgQ29udGFpbnMgY29udGV4dCBuZWVkZWQgZm9yIGV4ZWN1dGlvbiBpbmNsdWRpbmcgc291cmNlIGNvZGUsIG91dHB1dCBoYW5kbGVyLCBhbmQgVUkgZWxlbWVudHNcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUV4ZWN1dGlvbihibG9jazogQ29kZUJsb2NrQ29udGV4dCkge1xyXG4gICAgY29uc3QgbGFuZ3VhZ2U6IExhbmd1YWdlSWQgPSBibG9jay5sYW5ndWFnZTtcclxuICAgIGNvbnN0IGJ1dHRvbjogSFRNTEJ1dHRvbkVsZW1lbnQgPSBibG9jay5idXR0b247XHJcbiAgICBjb25zdCBzcmNDb2RlOiBzdHJpbmcgPSBibG9jay5zcmNDb2RlO1xyXG4gICAgY29uc3QgYXBwOiBBcHAgPSBibG9jay5vdXRwdXR0ZXIuYXBwO1xyXG4gICAgY29uc3QgczogRXhlY3V0b3JTZXR0aW5ncyA9IGJsb2NrLm91dHB1dHRlci5zZXR0aW5ncztcclxuXHJcbiAgICBidXR0b24uY2xhc3NOYW1lID0gZGlzYWJsZWRDbGFzcztcclxuICAgIGJsb2NrLnNyY0NvZGUgPSBhd2FpdCBuZXcgQ29kZUluamVjdG9yKGFwcCwgcywgbGFuZ3VhZ2UpLmluamVjdENvZGUoc3JjQ29kZSk7XHJcblxyXG4gICAgc3dpdGNoIChsYW5ndWFnZSkge1xyXG4gICAgICAgIGNhc2UgXCJqc1wiOiByZXR1cm4gcnVuQ29kZShzLm5vZGVQYXRoLCBzLm5vZGVBcmdzLCBzLmpzRmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgdHJhbnNmb3JtOiAoY29kZSkgPT4gbWFjcm8uZXhwYW5kSlMoY29kZSkgfSk7XHJcbiAgICAgICAgY2FzZSBcImphdmFcIjogcmV0dXJuIHJ1bkNvZGUocy5qYXZhUGF0aCwgcy5qYXZhQXJncywgcy5qYXZhRmlsZUV4dGVuc2lvbiwgYmxvY2spO1xyXG4gICAgICAgIGNhc2UgXCJweXRob25cIjogcmV0dXJuIHJ1bkNvZGUocy5weXRob25QYXRoLCBzLnB5dGhvbkFyZ3MsIHMucHl0aG9uRmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgdHJhbnNmb3JtOiAoY29kZSkgPT4gbWFjcm8uZXhwYW5kUHl0aG9uKGNvZGUsIHMpIH0pO1xyXG4gICAgICAgIGNhc2UgXCJzaGVsbFwiOiByZXR1cm4gcnVuQ29kZShzLnNoZWxsUGF0aCwgcy5zaGVsbEFyZ3MsIHMuc2hlbGxGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwiYmF0Y2hcIjogcmV0dXJuIHJ1bkNvZGUocy5iYXRjaFBhdGgsIHMuYmF0Y2hBcmdzLCBzLmJhdGNoRmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcInBvd2Vyc2hlbGxcIjogcmV0dXJuIHJ1bkNvZGUocy5wb3dlcnNoZWxsUGF0aCwgcy5wb3dlcnNoZWxsQXJncywgcy5wb3dlcnNoZWxsRmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcImNwcFwiOiByZXR1cm4gcnVuQ29kZShzLmNsaW5nUGF0aCwgYC1zdGQ9JHtzLmNsaW5nU3RkfSAke3MuY2xpbmdBcmdzfWAsIHMuY3BwRmlsZUV4dGVuc2lvbiwgYmxvY2spO1xyXG4gICAgICAgIGNhc2UgXCJwcm9sb2dcIjpcclxuICAgICAgICAgICAgcnVuQ29kZShcIlwiLCBcIlwiLCBcIlwiLCBibG9jayk7XHJcbiAgICAgICAgICAgIGJ1dHRvbi5jbGFzc05hbWUgPSBidXR0b25DbGFzcztcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcImdyb292eVwiOiByZXR1cm4gcnVuQ29kZShzLmdyb292eVBhdGgsIHMuZ3Jvb3Z5QXJncywgcy5ncm9vdnlGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwicnVzdFwiOiByZXR1cm4gcnVuQ29kZShzLmNhcmdvUGF0aCwgXCJldmFsXCIgKyBzLmNhcmdvRXZhbEFyZ3MsIHMucnVzdEZpbGVFeHRlbnNpb24sIGJsb2NrKTtcclxuICAgICAgICBjYXNlIFwiclwiOiByZXR1cm4gcnVuQ29kZShzLlJQYXRoLCBzLlJBcmdzLCBzLlJGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyB0cmFuc2Zvcm06IChjb2RlKSA9PiBtYWNyby5leHBhbmRSUGxvdHMoY29kZSkgfSk7XHJcbiAgICAgICAgY2FzZSBcImdvXCI6IHJldHVybiBydW5Db2RlKHMuZ29sYW5nUGF0aCwgcy5nb2xhbmdBcmdzLCBzLmdvbGFuZ0ZpbGVFeHRlbnNpb24sIGJsb2NrKTtcclxuICAgICAgICBjYXNlIFwia290bGluXCI6IHJldHVybiBydW5Db2RlKHMua290bGluUGF0aCwgcy5rb3RsaW5BcmdzLCBzLmtvdGxpbkZpbGVFeHRlbnNpb24sIGJsb2NrLCB7IHNoZWxsOiB0cnVlIH0pO1xyXG4gICAgICAgIGNhc2UgXCJ0c1wiOiByZXR1cm4gcnVuQ29kZShzLnRzUGF0aCwgcy50c0FyZ3MsIFwidHNcIiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcImx1YVwiOiByZXR1cm4gcnVuQ29kZShzLmx1YVBhdGgsIHMubHVhQXJncywgcy5sdWFGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwiZGFydFwiOiByZXR1cm4gcnVuQ29kZShzLmRhcnRQYXRoLCBzLmRhcnRBcmdzLCBzLmRhcnRGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwiY3NcIjogcmV0dXJuIHJ1bkNvZGUocy5jc1BhdGgsIHMuY3NBcmdzLCBzLmNzRmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcImhhc2tlbGxcIjogcmV0dXJuIChzLnVzZUdoY2kpXHJcbiAgICAgICAgICAgID8gcnVuQ29kZShzLmdoY2lQYXRoLCBcIlwiLCBcImhzXCIsIGJsb2NrLCB7IHNoZWxsOiB0cnVlIH0pXHJcbiAgICAgICAgICAgIDogcnVuQ29kZShzLnJ1bmdoY1BhdGgsIFwiLWYgXCIgKyBzLmdoY1BhdGgsIFwiaHNcIiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcIm1hdGhlbWF0aWNhXCI6IHJldHVybiBydW5Db2RlKHMubWF0aGVtYXRpY2FQYXRoLCBzLm1hdGhlbWF0aWNhQXJncywgcy5tYXRoZW1hdGljYUZpbGVFeHRlbnNpb24sIGJsb2NrLCB7IHNoZWxsOiB0cnVlIH0pO1xyXG4gICAgICAgIGNhc2UgXCJzY2FsYVwiOiByZXR1cm4gcnVuQ29kZShzLnNjYWxhUGF0aCwgcy5zY2FsYUFyZ3MsIHMuc2NhbGFGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwic3dpZnRcIjogcmV0dXJuIHJ1bkNvZGUocy5zd2lmdFBhdGgsIHMuc3dpZnRBcmdzLCBzLnN3aWZ0RmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcImNcIjogcmV0dXJuIHJ1bkNvZGUocy5jbGluZ1BhdGgsIHMuY2xpbmdBcmdzLCBcImNcIiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcInJ1YnlcIjogcmV0dXJuIHJ1bkNvZGUocy5ydWJ5UGF0aCwgcy5ydWJ5QXJncywgcy5ydWJ5RmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcInNxbFwiOiByZXR1cm4gcnVuQ29kZShzLnNxbFBhdGgsIHMuc3FsQXJncywgXCJzcWxcIiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcIm9jdGF2ZVwiOiByZXR1cm4gcnVuQ29kZShzLm9jdGF2ZVBhdGgsIHMub2N0YXZlQXJncywgcy5vY3RhdmVGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSwgdHJhbnNmb3JtOiAoY29kZSkgPT4gbWFjcm8uZXhwYW5kT2N0YXZlUGxvdChjb2RlKSB9KTtcclxuICAgICAgICBjYXNlIFwibWF4aW1hXCI6IHJldHVybiBydW5Db2RlKHMubWF4aW1hUGF0aCwgcy5tYXhpbWFBcmdzLCBzLm1heGltYUZpbGVFeHRlbnNpb24sIGJsb2NrLCB7IHNoZWxsOiB0cnVlLCB0cmFuc2Zvcm06IChjb2RlKSA9PiBtYWNyby5leHBhbmRNYXhpbWFQbG90KGNvZGUpIH0pO1xyXG4gICAgICAgIGNhc2UgXCJyYWNrZXRcIjogcmV0dXJuIHJ1bkNvZGUocy5yYWNrZXRQYXRoLCBzLnJhY2tldEFyZ3MsIHMucmFja2V0RmlsZUV4dGVuc2lvbiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcImFwcGxlc2NyaXB0XCI6IHJldHVybiBydW5Db2RlKHMuYXBwbGVzY3JpcHRQYXRoLCBzLmFwcGxlc2NyaXB0QXJncywgcy5hcHBsZXNjcmlwdEZpbGVFeHRlbnNpb24sIGJsb2NrLCB7IHNoZWxsOiB0cnVlIH0pO1xyXG4gICAgICAgIGNhc2UgXCJ6aWdcIjogcmV0dXJuIHJ1bkNvZGUocy56aWdQYXRoLCBzLnppZ0FyZ3MsIFwiemlnXCIsIGJsb2NrLCB7IHNoZWxsOiB0cnVlIH0pO1xyXG4gICAgICAgIGNhc2UgXCJvY2FtbFwiOiByZXR1cm4gcnVuQ29kZShzLm9jYW1sUGF0aCwgcy5vY2FtbEFyZ3MsIFwib2NhbWxcIiwgYmxvY2ssIHsgc2hlbGw6IHRydWUgfSk7XHJcbiAgICAgICAgY2FzZSBcInBocFwiOiByZXR1cm4gcnVuQ29kZShzLnBocFBhdGgsIHMucGhwQXJncywgcy5waHBGaWxlRXh0ZW5zaW9uLCBibG9jaywgeyBzaGVsbDogdHJ1ZSB9KTtcclxuICAgICAgICBjYXNlIFwibGF0ZXhcIjpcclxuICAgICAgICAgICAgY29uc3Qgb3V0cHV0UGF0aDogc3RyaW5nID0gYXdhaXQgcmV0cmlldmVGaWd1cmVQYXRoKGJsb2NrLnNyY0NvZGUsIHMubGF0ZXhGaWd1cmVUaXRsZVBhdHRlcm4sIGJsb2NrLm1hcmtkb3duRmlsZSwgcyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGludm9rZUNvbXBpbGVyOiBzdHJpbmcgPSBbcy5sYXRleFRleGZvdEFyZ3MsIHMubGF0ZXhDb21waWxlclBhdGgsIHMubGF0ZXhDb21waWxlckFyZ3NdLmpvaW4oXCIgXCIpO1xyXG4gICAgICAgICAgICByZXR1cm4gKCFzLmxhdGV4RG9GaWx0ZXIpXHJcbiAgICAgICAgICAgICAgICA/IHJ1bkNvZGUocy5sYXRleENvbXBpbGVyUGF0aCwgcy5sYXRleENvbXBpbGVyQXJncywgb3V0cHV0UGF0aCwgYmxvY2ssIHsgdHJhbnNmb3JtOiAoY29kZSkgPT4gbW9kaWZ5TGF0ZXhDb2RlKGNvZGUsIHMpIH0pXHJcbiAgICAgICAgICAgICAgICA6IHJ1bkNvZGUocy5sYXRleFRleGZvdFBhdGgsIGludm9rZUNvbXBpbGVyLCBvdXRwdXRQYXRoLCBibG9jaywgeyB0cmFuc2Zvcm06IChjb2RlKSA9PiBtb2RpZnlMYXRleENvZGUoY29kZSwgcykgfSk7XHJcbiAgICAgICAgZGVmYXVsdDogYnJlYWs7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBZGRzIHJ1biBidXR0b25zIHRvIGNvZGUgYmxvY2tzIGluIGFsbCBjdXJyZW50bHkgb3BlbiBNYXJrZG93biBmaWxlcy5cclxuICogTW9yZSBlZmZpY2llbnQgdGhhbiBzY2FubmluZyBlbnRpcmUgZG9jdW1lbnRzIHNpbmNlIGl0IG9ubHkgcHJvY2Vzc2VzIHZpc2libGUgY29udGVudC5cclxuICogQHBhcmFtIHBsdWdpbiBDb250YWlucyBjb250ZXh0IG5lZWRlZCBmb3IgZXhlY3V0aW9uLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZEluT3BlbkZpbGVzKHBsdWdpbjogUGx1Z2luQ29udGV4dCkge1xyXG4gICAgY29uc3Qgd29ya3NwYWNlOiBXb3Jrc3BhY2UgPSBwbHVnaW4uYXBwLndvcmtzcGFjZTtcclxuICAgIHdvcmtzcGFjZS5pdGVyYXRlUm9vdExlYXZlcyhsZWFmID0+IHtcclxuICAgICAgICBpZiAobGVhZi52aWV3IGluc3RhbmNlb2YgTWFya2Rvd25WaWV3KSB7XHJcbiAgICAgICAgICAgIGFkZFRvQWxsQ29kZUJsb2NrcyhsZWFmLnZpZXcuY29udGVudEVsLCBsZWFmLnZpZXcuZmlsZS5wYXRoLCBsZWFmLnZpZXcsIHBsdWdpbik7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBZGQgYSBidXR0b24gdG8gZWFjaCBjb2RlIGJsb2NrIHRoYXQgYWxsb3dzIHRoZSB1c2VyIHRvIHJ1biB0aGUgY29kZS4gVGhlIGJ1dHRvbiBpcyBvbmx5IGFkZGVkIGlmIHRoZSBjb2RlIGJsb2NrXHJcbiAqIHV0aWxpemVzIGEgbGFuZ3VhZ2UgdGhhdCBpcyBzdXBwb3J0ZWQgYnkgdGhpcyBwbHVnaW4uXHJcbiAqIEBwYXJhbSBlbGVtZW50IFRoZSBwYXJlbnQgZWxlbWVudCAoaS5lLiB0aGUgY3VycmVudGx5IHNob3dlZCBodG1sIHBhZ2UgLyBub3RlKS5cclxuICogQHBhcmFtIGZpbGUgQW4gaWRlbnRpZmllciBmb3IgdGhlIGN1cnJlbnRseSBzaG93ZWQgbm90ZVxyXG4gKiBAcGFyYW0gdmlldyBUaGUgY3VycmVudCBtYXJrZG93biB2aWV3XHJcbiAqIEBwYXJhbSBwbHVnaW4gQ29udGFpbnMgY29udGV4dCBuZWVkZWQgZm9yIGV4ZWN1dGlvbi5cclxuKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZFRvQWxsQ29kZUJsb2NrcyhlbGVtZW50OiBIVE1MRWxlbWVudCwgZmlsZTogc3RyaW5nLCB2aWV3OiBNYXJrZG93blZpZXcsIHBsdWdpbjogUGx1Z2luQ29udGV4dCkge1xyXG4gICAgQXJyYXkuZnJvbShlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiY29kZVwiKSlcclxuICAgICAgICAuZm9yRWFjaCgoY29kZUJsb2NrOiBIVE1MRWxlbWVudCkgPT4gYWRkVG9Db2RlQmxvY2soY29kZUJsb2NrLCBmaWxlLCB2aWV3LCBwbHVnaW4pKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFByb2Nlc3NlcyBhIGNvZGUgYmxvY2sgdG8gYWRkIGV4ZWN1dGlvbiBjYXBhYmlsaXRpZXMuIEVuc3VyZXMgYnV0dG9ucyBhcmVuJ3QgZHVwbGljYXRlZCBvbiBhbHJlYWR5IHByb2Nlc3NlZCBibG9ja3MuXHJcbiAqIEBwYXJhbSBjb2RlQmxvY2sgVGhlIGNvZGUgYmxvY2sgZWxlbWVudCB0byBwcm9jZXNzXHJcbiAqIEBwYXJhbSBmaWxlIFBhdGggdG8gdGhlIGN1cnJlbnQgbWFya2Rvd24gZmlsZVxyXG4gKiBAcGFyYW0gdmlldyBUaGUgY3VycmVudCBtYXJrZG93biB2aWV3XHJcbiAqIEBwYXJhbSBwbHVnaW4gQ29udGFpbnMgY29udGV4dCBuZWVkZWQgZm9yIGV4ZWN1dGlvbi5cclxuICovXHJcbmZ1bmN0aW9uIGFkZFRvQ29kZUJsb2NrKGNvZGVCbG9jazogSFRNTEVsZW1lbnQsIGZpbGU6IHN0cmluZywgdmlldzogTWFya2Rvd25WaWV3LCBwbHVnaW46IFBsdWdpbkNvbnRleHQpIHtcclxuICAgIGlmIChjb2RlQmxvY2suY2xhc3NOYW1lLm1hdGNoKC9ebGFuZ3VhZ2UtXFx7XFx3Ky9pKSkge1xyXG4gICAgICAgIGNvZGVCbG9jay5jbGFzc05hbWUgPSBjb2RlQmxvY2suY2xhc3NOYW1lLnJlcGxhY2UoL15sYW5ndWFnZS1cXHsoXFx3KykvaSwgXCJsYW5ndWFnZS0kMSB7XCIpO1xyXG4gICAgICAgIGNvZGVCbG9jay5wYXJlbnRFbGVtZW50LmNsYXNzTmFtZSA9IGNvZGVCbG9jay5jbGFzc05hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbGFuZ3VhZ2UgPSBjb2RlQmxvY2suY2xhc3NOYW1lLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgaWYgKCFsYW5ndWFnZSB8fCAhbGFuZ3VhZ2UuY29udGFpbnMoXCJsYW5ndWFnZS1cIikpXHJcbiAgICAgICAgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IHByZSA9IGNvZGVCbG9jay5wYXJlbnRFbGVtZW50IGFzIEhUTUxQcmVFbGVtZW50O1xyXG4gICAgY29uc3QgcGFyZW50ID0gcHJlLnBhcmVudEVsZW1lbnQgYXMgSFRNTERpdkVsZW1lbnQ7XHJcblxyXG4gICAgY29uc3Qgc3JjQ29kZSA9IGNvZGVCbG9jay5nZXRUZXh0KCk7XHJcbiAgICBsZXQgc2FuaXRpemVkQ2xhc3NMaXN0ID0gc2FuaXRpemVDbGFzc0xpc3RPZkNvZGVCbG9jayhjb2RlQmxvY2spO1xyXG5cclxuICAgIGNvbnN0IGNhbm9uaWNhbExhbmd1YWdlID0gZ2V0TGFuZ3VhZ2VBbGlhcyhcclxuICAgICAgICBzdXBwb3J0ZWRMYW5ndWFnZXMuZmluZChsYW5nID0+IHNhbml0aXplZENsYXNzTGlzdC5jb250YWlucyhgbGFuZ3VhZ2UtJHtsYW5nfWApKVxyXG4gICAgKSBhcyBMYW5ndWFnZUlkO1xyXG5cclxuICAgIGNvbnN0IGlzTGFuZ3VhZ2VTdXBwb3J0ZWQ6IEJvb2xlYW4gPSBjYW5vbmljYWxMYW5ndWFnZSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgY29uc3QgaGFzQmxvY2tCZWVuQnV0dG9uaWZpZWRBbHJlYWR5ID0gcGFyZW50LmNsYXNzTGlzdC5jb250YWlucyhjb2RlQmxvY2tIYXNCdXR0b25DbGFzcyk7XHJcbiAgICBpZiAoIWlzTGFuZ3VhZ2VTdXBwb3J0ZWQgfHwgaGFzQmxvY2tCZWVuQnV0dG9uaWZpZWRBbHJlYWR5KSByZXR1cm47XHJcblxyXG4gICAgY29uc3Qgb3V0cHV0dGVyID0gbmV3IE91dHB1dHRlcihjb2RlQmxvY2ssIHBsdWdpbi5zZXR0aW5ncywgdmlldywgcGx1Z2luLmFwcCwgZmlsZSk7XHJcbiAgICBwYXJlbnQuY2xhc3NMaXN0LmFkZChjb2RlQmxvY2tIYXNCdXR0b25DbGFzcyk7XHJcbiAgICBjb25zdCBidXR0b24gPSBjcmVhdGVCdXR0b24oKTtcclxuICAgIHByZS5hcHBlbmRDaGlsZChidXR0b24pO1xyXG5cclxuICAgIGNvbnN0IGJsb2NrOiBDb2RlQmxvY2tDb250ZXh0ID0ge1xyXG4gICAgICAgIHNyY0NvZGU6IHNyY0NvZGUsXHJcbiAgICAgICAgbGFuZ3VhZ2U6IGNhbm9uaWNhbExhbmd1YWdlLFxyXG4gICAgICAgIG1hcmtkb3duRmlsZTogZmlsZSxcclxuICAgICAgICBidXR0b246IGJ1dHRvbixcclxuICAgICAgICBvdXRwdXR0ZXI6IG91dHB1dHRlcixcclxuICAgICAgICBleGVjdXRvcnM6IHBsdWdpbi5leGVjdXRvcnMsXHJcbiAgICB9O1xyXG5cclxuICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4gaGFuZGxlRXhlY3V0aW9uKGJsb2NrKSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBOb3JtYWxpemVzIGxhbmd1YWdlIGNsYXNzIG5hbWVzIHRvIGVuc3VyZSBjb25zaXN0ZW50IHByb2Nlc3NpbmcuXHJcbiAqIEBwYXJhbSBjb2RlQmxvY2sgLSBUaGUgY29kZSBibG9jayBlbGVtZW50IHdob3NlIGNsYXNzZXMgbmVlZCB0byBiZSBzYW5pdGl6ZWRcclxuICogQHJldHVybnMgQXJyYXkgb2Ygbm9ybWFsaXplZCBjbGFzcyBuYW1lc1xyXG4gKi9cclxuZnVuY3Rpb24gc2FuaXRpemVDbGFzc0xpc3RPZkNvZGVCbG9jayhjb2RlQmxvY2s6IEhUTUxFbGVtZW50KSB7XHJcbiAgICBsZXQgc2FuaXRpemVkQ2xhc3NMaXN0ID0gQXJyYXkuZnJvbShjb2RlQmxvY2suY2xhc3NMaXN0KTtcclxuICAgIHJldHVybiBzYW5pdGl6ZWRDbGFzc0xpc3QubWFwKGMgPT4gYy50b0xvd2VyQ2FzZSgpKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYSBuZXcgcnVuIGJ1dHRvbiBhbmQgcmV0dXJucyBpdC5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvbigpOiBIVE1MQnV0dG9uRWxlbWVudCB7XHJcbiAgICBjb25zb2xlLmRlYnVnKFwiQWRkIHJ1biBidXR0b25cIik7XHJcbiAgICBjb25zdCBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYnV0dG9uXCIpO1xyXG4gICAgYnV0dG9uLmNsYXNzTGlzdC5hZGQoYnV0dG9uQ2xhc3MpO1xyXG4gICAgYnV0dG9uLnNldFRleHQoYnV0dG9uVGV4dCk7XHJcbiAgICByZXR1cm4gYnV0dG9uO1xyXG59XHJcblxyXG4vKipcclxuICogRXhlY3V0ZXMgdGhlIGNvZGUgd2l0aCB0aGUgZ2l2ZW4gY29tbWFuZCBhbmQgYXJndW1lbnRzLiBUaGUgY29kZSBpcyB3cml0dGVuIHRvIGEgdGVtcG9yYXJ5IGZpbGUgYW5kIHRoZW4gZXhlY3V0ZWQuXHJcbiAqIFRoZSBvdXRwdXQgb2YgdGhlIGNvZGUgaXMgZGlzcGxheWVkIGluIHRoZSBvdXRwdXQgcGFuZWwgKHtAbGluayBPdXRwdXR0ZXJ9KS5cclxuICogSWYgdGhlIGNvZGUgZXhlY3V0aW9uIGZhaWxzLCBhbiBlcnJvciBtZXNzYWdlIGlzIGRpc3BsYXllZCBhbmQgbG9nZ2VkLlxyXG4gKiBBZnRlciB0aGUgY29kZSBleGVjdXRpb24sIHRoZSB0ZW1wb3JhcnkgZmlsZSBpcyBkZWxldGVkIGFuZCB0aGUgcnVuIGJ1dHRvbiBpcyByZS1lbmFibGVkLlxyXG4gKiBAcGFyYW0gY21kIFRoZSBjb21tYW5kIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gZXhlY3V0ZSB0aGUgY29kZS4gKGUuZy4gcHl0aG9uLCBqYXZhLCAuLi4pXHJcbiAqIEBwYXJhbSBjbWRBcmdzIEFkZGl0aW9uYWwgYXJndW1lbnRzIHRoYXQgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgY29tbWFuZC5cclxuICogQHBhcmFtIGV4dCBUaGUgZmlsZSBleHRlbnNpb24gb2YgdGhlIHRlbXBvcmFyeSBmaWxlLiBTaG91bGQgY29ycmVzcG9uZCB0byB0aGUgbGFuZ3VhZ2Ugb2YgdGhlIGNvZGUuIChlLmcuIHB5LCAuLi4pXHJcbiAqIEBwYXJhbSBibG9jayBDb250YWlucyBjb250ZXh0IG5lZWRlZCBmb3IgZXhlY3V0aW9uIGluY2x1ZGluZyBzb3VyY2UgY29kZSwgb3V0cHV0IGhhbmRsZXIsIGFuZCBVSSBlbGVtZW50c1xyXG4gKi9cclxuZnVuY3Rpb24gcnVuQ29kZShjbWQ6IHN0cmluZywgY21kQXJnczogc3RyaW5nLCBleHQ6IHN0cmluZywgYmxvY2s6IENvZGVCbG9ja0NvbnRleHQsIG9wdGlvbnM/OiB7IHNoZWxsPzogYm9vbGVhbjsgdHJhbnNmb3JtPzogKGNvZGU6IHN0cmluZykgPT4gc3RyaW5nOyB9KSB7XHJcbiAgICBjb25zdCB1c2VTaGVsbDogYm9vbGVhbiA9IChvcHRpb25zPy5zaGVsbCkgPyBvcHRpb25zLnNoZWxsIDogZmFsc2U7XHJcbiAgICBpZiAob3B0aW9ucz8udHJhbnNmb3JtKSBibG9jay5zcmNDb2RlID0gb3B0aW9ucy50cmFuc2Zvcm0oYmxvY2suc3JjQ29kZSk7XHJcbiAgICBpZiAoIXVzZVNoZWxsKSBibG9jay5vdXRwdXR0ZXIuc3RhcnRCbG9jaygpO1xyXG5cclxuICAgIGNvbnN0IGV4ZWN1dG9yID0gYmxvY2suZXhlY3V0b3JzLmdldEV4ZWN1dG9yRm9yKGJsb2NrLm1hcmtkb3duRmlsZSwgYmxvY2subGFuZ3VhZ2UsIHVzZVNoZWxsKTtcclxuICAgIGV4ZWN1dG9yLnJ1bihibG9jay5zcmNDb2RlLCBibG9jay5vdXRwdXR0ZXIsIGNtZCwgY21kQXJncywgZXh0KS50aGVuKCgpID0+IHtcclxuICAgICAgICBibG9jay5idXR0b24uY2xhc3NOYW1lID0gYnV0dG9uQ2xhc3M7XHJcbiAgICAgICAgaWYgKCF1c2VTaGVsbCkge1xyXG4gICAgICAgICAgICBibG9jay5vdXRwdXR0ZXIuY2xvc2VJbnB1dCgpO1xyXG4gICAgICAgICAgICBibG9jay5vdXRwdXR0ZXIuZmluaXNoQmxvY2soKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG4iXX0=