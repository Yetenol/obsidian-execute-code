import { Platform } from 'obsidian';
import * as path from 'path';
let validFonts = new Set;
let invalidFonts = new Set;
/** Generates LaTeX font configuration based on system or Obsidian fonts. */
export function addFontSpec(settings) {
    const isPdflatex = path.basename(settings.latexCompilerPath).toLowerCase().includes('pdflatex');
    if (isPdflatex || settings.latexAdaptFont === '')
        return '';
    const platformFonts = getPlatformFonts();
    const fontSpec = buildFontCommand(settings, platformFonts);
    if (!fontSpec)
        return '';
    const packageSrc = `\\usepackage{fontspec}\n`;
    return packageSrc + fontSpec;
}
/** Retrieves Obsidian's font settings from CSS variables. */
function getObsidianFonts(cssVariable) {
    const cssDeclarations = getComputedStyle(document.body);
    const fonts = cssDeclarations.getPropertyValue(cssVariable).split(`'??'`)[0];
    return sanitizeCommaList(fonts);
}
/** Constructs LaTeX font commands based on the provided settings and platform-specific fonts. */
function buildFontCommand(settings, fonts) {
    if (settings.latexAdaptFont === 'obsidian') {
        fonts.main = [getObsidianFonts('--font-text'), fonts.main].join(',');
        fonts.sans = [getObsidianFonts('--font-interface'), fonts.sans].join(',');
        fonts.mono = [getObsidianFonts('--font-monospace'), fonts.mono].join(',');
    }
    const mainSrc = buildSetfont('main', fonts.main);
    const sansSrc = buildSetfont('sans', fonts.sans);
    const monoSrc = buildSetfont('mono', fonts.mono);
    return mainSrc + sansSrc + monoSrc;
}
/** Returns default system fonts based on current platform */
function getPlatformFonts() {
    if (Platform.isWin)
        return { main: 'Segoe UI', sans: 'Segoe UI', mono: 'Consolas' };
    if (Platform.isMacOS)
        return { main: 'SF Pro', sans: 'SF Pro', mono: 'SF Mono' };
    if (Platform.isLinux)
        return { main: 'DejaVu Sans', sans: 'DejaVu Sans', mono: 'DejaVu Sans Mono' };
    return { main: '', sans: '', mono: '' };
}
/** Generates LuaLaTeX setfont command for specified font type. */
function buildSetfont(type, fallbackList) {
    const font = firstValidFont(fallbackList);
    return (font) ? `\\set${type}font{${font}}\n` : '';
}
function firstValidFont(fallbackList) {
    return sanitizeCommaList(fallbackList)
        .split(', ')
        .reduce((result, font) => result || (cachedTestFont(font) ? font : undefined), undefined);
}
/** For performance, do not retest a font during the app's lifetime. */
function cachedTestFont(fontName) {
    if (validFonts.has(fontName))
        return true;
    if (invalidFonts.has(fontName))
        return false;
    if (!testFont(fontName)) {
        invalidFonts.add(fontName);
        return false;
    }
    validFonts.add(fontName);
    return true;
}
/** Tests if a font is available by comparing text measurements on canvas. */
function testFont(fontName) {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    if (!context)
        return false;
    const text = 'abcdefghijklmnopqrstuvwxyz';
    context.font = `16px monospace`;
    const baselineWidth = context.measureText(text).width;
    context.font = `16px "${fontName}", monospace`;
    const testWidth = context.measureText(text).width;
    const isFontAvailable = baselineWidth !== testWidth;
    console.debug((isFontAvailable) ? `Font ${fontName} accepted.` : `Font ${fontName} ignored.`);
    return isFontAvailable;
}
/** Cleans and normalizes comma-separated font family lists */
function sanitizeCommaList(commaList) {
    return commaList
        .split(',')
        .map(font => font.trim().replace(/^["']|["']$/g, ''))
        .filter(Boolean)
        .join(', ');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF0ZXhGb250SGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkxhdGV4Rm9udEhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUc3QixJQUFJLFVBQVUsR0FBRyxJQUFJLEdBQVcsQ0FBQztBQUNqQyxJQUFJLFlBQVksR0FBRyxJQUFJLEdBQVcsQ0FBQztBQVFuQyw0RUFBNEU7QUFDNUUsTUFBTSxVQUFVLFdBQVcsQ0FBQyxRQUEwQjtJQUNsRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoRyxJQUFJLFVBQVUsSUFBSSxRQUFRLENBQUMsY0FBYyxLQUFLLEVBQUU7UUFBRSxPQUFPLEVBQUUsQ0FBQztJQUU1RCxNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ3pDLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUMzRCxJQUFJLENBQUMsUUFBUTtRQUFFLE9BQU8sRUFBRSxDQUFDO0lBRXpCLE1BQU0sVUFBVSxHQUFHLDBCQUEwQixDQUFDO0lBQzlDLE9BQU8sVUFBVSxHQUFHLFFBQVEsQ0FBQztBQUNqQyxDQUFDO0FBRUQsNkRBQTZEO0FBQzdELFNBQVMsZ0JBQWdCLENBQUMsV0FBbUI7SUFDekMsTUFBTSxlQUFlLEdBQUcsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hELE1BQU0sS0FBSyxHQUFHLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0UsT0FB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LEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3BELE1BQU0sQ0FBQyxPQUFPLENBQUM7U0FDZixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnb2JzaWRpYW4nO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBFeGVjdXRvclNldHRpbmdzIH0gZnJvbSAnc3JjL3NldHRpbmdzL1NldHRpbmdzJztcclxuXHJcbmxldCB2YWxpZEZvbnRzID0gbmV3IFNldDxzdHJpbmc+O1xyXG5sZXQgaW52YWxpZEZvbnRzID0gbmV3IFNldDxzdHJpbmc+O1xyXG5cclxuaW50ZXJmYWNlIEZvbnROYW1lcyB7XHJcbiAgICBtYWluOiBzdHJpbmc7XHJcbiAgICBzYW5zOiBzdHJpbmc7XHJcbiAgICBtb25vOiBzdHJpbmc7XHJcbn1cclxuXHJcbi8qKiBHZW5lcmF0ZXMgTGFUZVggZm9udCBjb25maWd1cmF0aW9uIGJhc2VkIG9uIHN5c3RlbSBvciBPYnNpZGlhbiBmb250cy4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZEZvbnRTcGVjKHNldHRpbmdzOiBFeGVjdXRvclNldHRpbmdzKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGlzUGRmbGF0ZXggPSBwYXRoLmJhc2VuYW1lKHNldHRpbmdzLmxhdGV4Q29tcGlsZXJQYXRoKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdwZGZsYXRleCcpO1xyXG4gICAgaWYgKGlzUGRmbGF0ZXggfHwgc2V0dGluZ3MubGF0ZXhBZGFwdEZvbnQgPT09ICcnKSByZXR1cm4gJyc7XHJcblxyXG4gICAgY29uc3QgcGxhdGZvcm1Gb250cyA9IGdldFBsYXRmb3JtRm9udHMoKTtcclxuICAgIGNvbnN0IGZvbnRTcGVjID0gYnVpbGRGb250Q29tbWFuZChzZXR0aW5ncywgcGxhdGZvcm1Gb250cyk7XHJcbiAgICBpZiAoIWZvbnRTcGVjKSByZXR1cm4gJyc7XHJcblxyXG4gICAgY29uc3QgcGFja2FnZVNyYyA9IGBcXFxcdXNlcGFja2FnZXtmb250c3BlY31cXG5gO1xyXG4gICAgcmV0dXJuIHBhY2thZ2VTcmMgKyBmb250U3BlYztcclxufVxyXG5cclxuLyoqIFJldHJpZXZlcyBPYnNpZGlhbidzIGZvbnQgc2V0dGluZ3MgZnJvbSBDU1MgdmFyaWFibGVzLiAqL1xyXG5mdW5jdGlvbiBnZXRPYnNpZGlhbkZvbnRzKGNzc1ZhcmlhYmxlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgY3NzRGVjbGFyYXRpb25zID0gZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5ib2R5KTtcclxuICAgIGNvbnN0IGZvbnRzID0gY3NzRGVjbGFyYXRpb25zLmdldFByb3BlcnR5VmFsdWUoY3NzVmFyaWFibGUpLnNwbGl0KGAnPz8nYClbMF07XHJcbiAgICByZXR1cm4gc2FuaXRpemVDb21tYUxpc3QoZm9udHMpO1xyXG59XHJcblxyXG4vKiogQ29uc3RydWN0cyBMYVRlWCBmb250IGNvbW1hbmRzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCBzZXR0aW5ncyBhbmQgcGxhdGZvcm0tc3BlY2lmaWMgZm9udHMuICovXHJcbmZ1bmN0aW9uIGJ1aWxkRm9udENvbW1hbmQoc2V0dGluZ3M6IEV4ZWN1dG9yU2V0dGluZ3MsIGZvbnRzOiBGb250TmFtZXMpOiBzdHJpbmcge1xyXG4gICAgaWYgKHNldHRpbmdzLmxhdGV4QWRhcHRGb250ID09PSAnb2JzaWRpYW4nKSB7XHJcbiAgICAgICAgZm9udHMubWFpbiA9IFtnZXRPYnNpZGlhbkZvbnRzKCctLWZvbnQtdGV4dCcpLCBmb250cy5tYWluXS5qb2luKCcsJyk7XHJcbiAgICAgICAgZm9udHMuc2FucyA9IFtnZXRPYnNpZGlhbkZvbnRzKCctLWZvbnQtaW50ZXJmYWNlJyksIGZvbnRzLnNhbnNdLmpvaW4oJywnKTtcclxuICAgICAgICBmb250cy5tb25vID0gW2dldE9ic2lkaWFuRm9udHMoJy0tZm9udC1tb25vc3BhY2UnKSwgZm9udHMubW9ub10uam9pbignLCcpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWFpblNyYyA9IGJ1aWxkU2V0Zm9udCgnbWFpbicsIGZvbnRzLm1haW4pO1xyXG4gICAgY29uc3Qgc2Fuc1NyYyA9IGJ1aWxkU2V0Zm9udCgnc2FucycsIGZvbnRzLnNhbnMpO1xyXG4gICAgY29uc3QgbW9ub1NyYyA9IGJ1aWxkU2V0Zm9udCgnbW9ubycsIGZvbnRzLm1vbm8pO1xyXG4gICAgcmV0dXJuIG1haW5TcmMgKyBzYW5zU3JjICsgbW9ub1NyYztcclxufVxyXG5cclxuLyoqIFJldHVybnMgZGVmYXVsdCBzeXN0ZW0gZm9udHMgYmFzZWQgb24gY3VycmVudCBwbGF0Zm9ybSAqL1xyXG5mdW5jdGlvbiBnZXRQbGF0Zm9ybUZvbnRzKCk6IEZvbnROYW1lcyB7XHJcbiAgICBpZiAoUGxhdGZvcm0uaXNXaW4pIHJldHVybiB7IG1haW46ICdTZWdvZSBVSScsIHNhbnM6ICdTZWdvZSBVSScsIG1vbm86ICdDb25zb2xhcycgfTtcclxuICAgIGlmIChQbGF0Zm9ybS5pc01hY09TKSByZXR1cm4geyBtYWluOiAnU0YgUHJvJywgc2FuczogJ1NGIFBybycsIG1vbm86ICdTRiBNb25vJyB9O1xyXG4gICAgaWYgKFBsYXRmb3JtLmlzTGludXgpIHJldHVybiB7IG1haW46ICdEZWphVnUgU2FucycsIHNhbnM6ICdEZWphVnUgU2FucycsIG1vbm86ICdEZWphVnUgU2FucyBNb25vJyB9O1xyXG4gICAgcmV0dXJuIHsgbWFpbjogJycsIHNhbnM6ICcnLCBtb25vOiAnJyB9O1xyXG59XHJcblxyXG4vKiogR2VuZXJhdGVzIEx1YUxhVGVYIHNldGZvbnQgY29tbWFuZCBmb3Igc3BlY2lmaWVkIGZvbnQgdHlwZS4gKi9cclxuZnVuY3Rpb24gYnVpbGRTZXRmb250KHR5cGU6ICdtYWluJyB8ICdtb25vJyB8ICdzYW5zJywgZmFsbGJhY2tMaXN0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgZm9udCA9IGZpcnN0VmFsaWRGb250KGZhbGxiYWNrTGlzdCk7XHJcbiAgICByZXR1cm4gKGZvbnQpID8gYFxcXFxzZXQke3R5cGV9Zm9udHske2ZvbnR9fVxcbmAgOiAnJztcclxufVxyXG5cclxuZnVuY3Rpb24gZmlyc3RWYWxpZEZvbnQoZmFsbGJhY2tMaXN0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHNhbml0aXplQ29tbWFMaXN0KGZhbGxiYWNrTGlzdClcclxuICAgICAgICAuc3BsaXQoJywgJylcclxuICAgICAgICAucmVkdWNlKChyZXN1bHQsIGZvbnQpID0+IHJlc3VsdCB8fCAoY2FjaGVkVGVzdEZvbnQoZm9udCkgPyBmb250IDogdW5kZWZpbmVkKSwgdW5kZWZpbmVkKTtcclxufVxyXG5cclxuLyoqIEZvciBwZXJmb3JtYW5jZSwgZG8gbm90IHJldGVzdCBhIGZvbnQgZHVyaW5nIHRoZSBhcHAncyBsaWZldGltZS4gKi9cclxuZnVuY3Rpb24gY2FjaGVkVGVzdEZvbnQoZm9udE5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHZhbGlkRm9udHMuaGFzKGZvbnROYW1lKSkgcmV0dXJuIHRydWU7XHJcbiAgICBpZiAoaW52YWxpZEZvbnRzLmhhcyhmb250TmFtZSkpIHJldHVybiBmYWxzZTtcclxuICAgIGlmICghdGVzdEZvbnQoZm9udE5hbWUpKSB7XHJcbiAgICAgICAgaW52YWxpZEZvbnRzLmFkZChmb250TmFtZSk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgdmFsaWRGb250cy5hZGQoZm9udE5hbWUpO1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbi8qKiBUZXN0cyBpZiBhIGZvbnQgaXMgYXZhaWxhYmxlIGJ5IGNvbXBhcmluZyB0ZXh0IG1lYXN1cmVtZW50cyBvbiBjYW52YXMuICovXHJcbmZ1bmN0aW9uIHRlc3RGb250KGZvbnROYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xyXG4gICAgaWYgKCFjb250ZXh0KSByZXR1cm4gZmFsc2U7XHJcblxyXG4gICAgY29uc3QgdGV4dCA9ICdhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5eic7XHJcbiAgICBjb250ZXh0LmZvbnQgPSBgMTZweCBtb25vc3BhY2VgO1xyXG4gICAgY29uc3QgYmFzZWxpbmVXaWR0aCA9IGNvbnRleHQubWVhc3VyZVRleHQodGV4dCkud2lkdGg7XHJcblxyXG4gICAgY29udGV4dC5mb250ID0gYDE2cHggXCIke2ZvbnROYW1lfVwiLCBtb25vc3BhY2VgO1xyXG4gICAgY29uc3QgdGVzdFdpZHRoID0gY29udGV4dC5tZWFzdXJlVGV4dCh0ZXh0KS53aWR0aDtcclxuXHJcbiAgICBjb25zdCBpc0ZvbnRBdmFpbGFibGUgPSBiYXNlbGluZVdpZHRoICE9PSB0ZXN0V2lkdGg7XHJcbiAgICBjb25zb2xlLmRlYnVnKChpc0ZvbnRBdmFpbGFibGUpID8gYEZvbnQgJHtmb250TmFtZX0gYWNjZXB0ZWQuYCA6IGBGb250ICR7Zm9udE5hbWV9IGlnbm9yZWQuYCk7XHJcbiAgICByZXR1cm4gaXNGb250QXZhaWxhYmxlO1xyXG59XHJcblxyXG4vKiogQ2xlYW5zIGFuZCBub3JtYWxpemVzIGNvbW1hLXNlcGFyYXRlZCBmb250IGZhbWlseSBsaXN0cyAqL1xyXG5mdW5jdGlvbiBzYW5pdGl6ZUNvbW1hTGlzdChjb21tYUxpc3Q6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gY29tbWFMaXN0XHJcbiAgICAgICAgLnNwbGl0KCcsJylcclxuICAgICAgICAubWFwKGZvbnQgPT4gZm9udC50cmltKCkucmVwbGFjZSgvXltcIiddfFtcIiddJC9nLCAnJykpXHJcbiAgICAgICAgLmZpbHRlcihCb29sZWFuKVxyXG4gICAgICAgIC5qb2luKCcsICcpO1xyXG59XHJcbiJdfQ==