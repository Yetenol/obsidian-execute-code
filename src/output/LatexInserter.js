import { settingsInstance } from "src/transforms/LatexTransformer";
import { FIGURE_FILENAME_EXTENSIONS, TEMP_FIGURE_NAME } from 'src/transforms/LatexFigureName';
import { generalizeFigureTitle } from 'src/transforms/LatexFigureName';
import * as r from "./RegExpUtilities";
import * as path from "path";
const LINK_ALIAS = /\|[^\]]*/;
const ANY_WIKILINK_EMBEDDING = r.concat(/!\[\[.*?/, FIGURE_FILENAME_EXTENSIONS, r.optional(LINK_ALIAS), /\]\]/);
const ANY_MARKDOWN_EMBEDDING = r.concat(/!\[.*?\]\(.*?/, FIGURE_FILENAME_EXTENSIONS, /\)/);
const ANY_FIGURE_EMBEDDING = r.alternate(ANY_WIKILINK_EMBEDDING, ANY_MARKDOWN_EMBEDDING);
const SAFE_ANY = /([^`]|`[^`]|``[^`])*?/; // Match any text, that does not cross the ``` boundary of code blocks
const EMPTY_LINES = /[\s\n]*/;
/** Forces an image to reload by appending a cache-busting timestamp to its URL */
export function updateImage(image) {
    const baseUrl = image.src.split('?')[0];
    image.src = `${baseUrl}?cache=${Date.now()}`;
}
/**
 * Adds an obsidian link and clickable insertion icons to the output.
 * @param figureName - The name of the figure file with extension that was saved
 * @param figurePath - The path where the figure was saved
 * @param outputter - The Outputter instance used to write content
 */
export async function writeFileLink(figureName, figurePath, outputter) {
    await outputter.writeMarkdown(`Saved [[${figureName}]]`);
    const isTempFigure = TEMP_FIGURE_NAME.test(figureName);
    if (isTempFigure)
        return outputter.write('\n');
    const file = outputter.app.vault.getFileByPath(outputter.srcFile);
    if (!file)
        throw new Error(`File not found: ${outputter.srcFile}`);
    const link = () => createObsidianLink(outputter.app, figurePath, outputter.srcFile);
    const figure = { app: outputter.app, figureName: figureName, link: link, file: file };
    const buttonClass = 'insert-figure-icon';
    const insertAbove = outputter.writeIcon('image-up', 'Click to embed file above codeblock.\nCtrl + Click to replace previous embedding.', buttonClass);
    insertAbove.addEventListener('click', (event) => insertEmbedding('above', event.ctrlKey, figure));
    const insertBelow = outputter.writeIcon('image-down', 'Click to embed file below codeblock.\nCtrl + Click to replace next embedding.', buttonClass);
    insertBelow.addEventListener('click', (event) => insertEmbedding('below', event.ctrlKey, figure));
    const copyLink = outputter.writeIcon('copy', 'Copy the markdown link.', buttonClass);
    copyLink.addEventListener('click', () => navigator.clipboard.writeText(link()));
    outputter.write('\n');
}
/** * Inserts an embedded link to the figure above or below the current code blocks. */
async function insertEmbedding(pastePosition, doReplace, figure) {
    try {
        const vault = figure.app.vault;
        const content = await vault.read(figure.file);
        const identifierSrc = settingsInstance.latexFigureTitlePattern
            .replace(/\(\?<name>[^)]*\)/, generalizeFigureTitle(figure.figureName).source);
        const identifier = r.parse(identifierSrc);
        if (!identifier)
            return;
        const codeBlocks = findMatchingCodeBlocks(content, /(la)?tex/, identifier, figure.link(), doReplace);
        if (codeBlocks.length === 0)
            return false;
        codeBlocks.forEach(async (block) => {
            await insertAtCodeBlock(block, pastePosition, figure);
        });
        return true;
    }
    catch (error) {
        console.error('Error inserting embedding:', error);
        throw error;
    }
}
/** Locates LaTeX code blocks containing the specified figure identifier and their surrounding embeddings */
function findMatchingCodeBlocks(content, language, identifier, link, doReplace) {
    const alreadyLinked = r.group(r.escape(link));
    const codeblock = r.concat(/```(run-)?/, r.group(language), /[\s\n]/, SAFE_ANY, r.group(identifier), SAFE_ANY, /```/);
    const previous = r.capture(r.concat(ANY_FIGURE_EMBEDDING, EMPTY_LINES), 'replacePrevious');
    const above = r.capture(r.concat(alreadyLinked, EMPTY_LINES), 'alreadyAbove');
    const below = r.capture(r.concat(EMPTY_LINES, alreadyLinked), 'alreadyBelow');
    const next = r.capture(r.concat(EMPTY_LINES, ANY_FIGURE_EMBEDDING), 'replaceNext');
    const blocksWithEmbeds = new RegExp(r.concat((doReplace) ? r.optional(previous) : null, r.optional(above), r.capture(codeblock, 'codeblock'), r.optional(below), (doReplace) ? r.optional(next) : null), 'g');
    const matches = Array.from(content.matchAll(blocksWithEmbeds));
    console.debug(`Searching markdown for`, blocksWithEmbeds, `resulted in `, matches.length, `codeblock(s)`, matches.map(match => match.groups));
    return matches;
}
/** Updates markdown source file to insert or replace a figure embedding relative to a code block */
async function insertAtCodeBlock(block, pastePosition, figure) {
    var _a, _b, _c, _d;
    const vault = figure.app.vault;
    const groups = block.groups;
    if (!groups || !groups.codeblock)
        return;
    const canReplace = (pastePosition === 'above')
        ? ((_a = groups.replacePrevious) === null || _a === void 0 ? void 0 : _a.length) > 0
        : ((_b = groups.replaceNext) === null || _b === void 0 ? void 0 : _b.length) > 0;
    const isAlreadyEmbedded = (pastePosition === 'above')
        ? ((_c = groups.alreadyAbove) === null || _c === void 0 ? void 0 : _c.length) > 0
        : ((_d = groups.alreadyBelow) === null || _d === void 0 ? void 0 : _d.length) > 0;
    if (isAlreadyEmbedded && !canReplace)
        return;
    const newText = (pastePosition === 'above')
        ? figure.link() + '\n\n' + groups.codeblock
        : groups.codeblock + '\n\n' + figure.link();
    if (!canReplace) {
        await vault.process(figure.file, data => data.replace(groups.codeblock, newText));
        return;
    }
    const oldTexts = (pastePosition === 'above')
        ? [groups.replacePrevious, groups.alreadyAbove, groups.codeblock]
        : [groups.codeblock, groups.alreadyBelow, groups.replaceNext];
    const oldCombined = oldTexts.filter(Boolean).join('');
    await vault.process(figure.file, data => data.replace(oldCombined, newText));
}
/** Let Obsidian generate a link adhering to preferences */
export function createObsidianLink(app, filePath, sourcePath, subpath, alias) {
    const relative = getPathRelativeToVault(filePath);
    try {
        const file = app.vault.getFileByPath(relative);
        return app.fileManager.generateMarkdownLink(file, sourcePath, subpath, alias);
    }
    catch (error) {
        console.error(`File not found: ${relative}`);
        return '![[' + path.basename(filePath) + ']]';
    }
}
function getPathRelativeToVault(absolutePath) {
    const vaultPath = this.app.vault.adapter.basePath;
    absolutePath = path.normalize(absolutePath);
    if (!absolutePath.startsWith(vaultPath))
        return absolutePath;
    return absolutePath.slice(vaultPath.length)
        .replace(/^[\\\/]/, '')
        .replace(/\\/g, '/')
        .replace(/['"`]/, '')
        .trim();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF0ZXhJbnNlcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkxhdGV4SW5zZXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDbkUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDOUYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDdkUsT0FBTyxLQUFLLENBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUN2QyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUU3QixNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUM7QUFDOUIsTUFBTSxzQkFBc0IsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSwwQkFBMEIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ2hILE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsMEJBQTBCLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDM0YsTUFBTSxvQkFBb0IsR0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLHNCQUFzQixFQUFFLHNCQUFzQixDQUFDLENBQUM7QUFFakcsTUFBTSxRQUFRLEdBQVcsdUJBQXVCLENBQUMsQ0FBQyxzRUFBc0U7QUFDeEgsTUFBTSxXQUFXLEdBQVcsU0FBUyxDQUFDO0FBU3RDLGtGQUFrRjtBQUNsRixNQUFNLFVBQVUsV0FBVyxDQUFDLEtBQXVCO0lBQy9DLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxPQUFPLFVBQVUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7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QUFDO0FBRUQsU0FBUyxzQkFBc0IsQ0FBQyxZQUFvQjtJQUNoRCxNQUFNLFNBQVMsR0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFlLENBQUMsUUFBUSxDQUFDO0lBQzNELFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBRTVDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQztRQUFFLE9BQU8sWUFBWSxDQUFDO0lBQzdELE9BQU8sWUFBWSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO1NBQ3RDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDO1NBQ3RCLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDO1NBQ25CLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1NBQ3BCLElBQUksRUFBRSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIHNldEljb24sIFRGaWxlLCBWYXVsdCB9IGZyb20gXCJvYnNpZGlhblwiO1xyXG5pbXBvcnQgeyBPdXRwdXR0ZXIgfSBmcm9tIFwiLi9PdXRwdXR0ZXJcIjtcclxuaW1wb3J0IHsgc2V0dGluZ3NJbnN0YW5jZSB9IGZyb20gXCJzcmMvdHJhbnNmb3Jtcy9MYXRleFRyYW5zZm9ybWVyXCI7XHJcbmltcG9ydCB7IEZJR1VSRV9GSUxFTkFNRV9FWFRFTlNJT05TLCBURU1QX0ZJR1VSRV9OQU1FIH0gZnJvbSAnc3JjL3RyYW5zZm9ybXMvTGF0ZXhGaWd1cmVOYW1lJztcclxuaW1wb3J0IHsgZ2VuZXJhbGl6ZUZpZ3VyZVRpdGxlIH0gZnJvbSAnc3JjL3RyYW5zZm9ybXMvTGF0ZXhGaWd1cmVOYW1lJztcclxuaW1wb3J0ICogYXMgciBmcm9tIFwiLi9SZWdFeHBVdGlsaXRpZXNcIjtcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5cclxuY29uc3QgTElOS19BTElBUyA9IC9cXHxbXlxcXV0qLztcclxuY29uc3QgQU5ZX1dJS0lMSU5LX0VNQkVERElORyA9IHIuY29uY2F0KC8hXFxbXFxbLio/LywgRklHVVJFX0ZJTEVOQU1FX0VYVEVOU0lPTlMsIHIub3B0aW9uYWwoTElOS19BTElBUyksIC9cXF1cXF0vKTtcclxuY29uc3QgQU5ZX01BUktET1dOX0VNQkVERElORyA9IHIuY29uY2F0KC8hXFxbLio/XFxdXFwoLio/LywgRklHVVJFX0ZJTEVOQU1FX0VYVEVOU0lPTlMsIC9cXCkvKTtcclxuY29uc3QgQU5ZX0ZJR1VSRV9FTUJFRERJTkc6IFJlZ0V4cCA9IHIuYWx0ZXJuYXRlKEFOWV9XSUtJTElOS19FTUJFRERJTkcsIEFOWV9NQVJLRE9XTl9FTUJFRERJTkcpO1xyXG5cclxuY29uc3QgU0FGRV9BTlk6IFJlZ0V4cCA9IC8oW15gXXxgW15gXXxgYFteYF0pKj8vOyAvLyBNYXRjaCBhbnkgdGV4dCwgdGhhdCBkb2VzIG5vdCBjcm9zcyB0aGUgYGBgIGJvdW5kYXJ5IG9mIGNvZGUgYmxvY2tzXHJcbmNvbnN0IEVNUFRZX0xJTkVTOiBSZWdFeHAgPSAvW1xcc1xcbl0qLztcclxuXHJcbmludGVyZmFjZSBGaWd1cmVDb250ZXh0IHtcclxuICAgIGFwcDogQXBwO1xyXG4gICAgZmlndXJlTmFtZTogc3RyaW5nO1xyXG4gICAgbGluazogKCkgPT4gc3RyaW5nOyAvLyBldmFsdWF0ZXMgYXQgYnV0dG9uIGNsaWNrLCB0byBsZXQgT2JzaWRpYW4gaW5kZXggdGhlIGZpbGVcclxuICAgIGZpbGU6IFRGaWxlO1xyXG59XHJcblxyXG4vKiogRm9yY2VzIGFuIGltYWdlIHRvIHJlbG9hZCBieSBhcHBlbmRpbmcgYSBjYWNoZS1idXN0aW5nIHRpbWVzdGFtcCB0byBpdHMgVVJMICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVJbWFnZShpbWFnZTogSFRNTEltYWdlRWxlbWVudCkge1xyXG4gICAgY29uc3QgYmFzZVVybCA9IGltYWdlLnNyYy5zcGxpdCgnPycpWzBdO1xyXG4gICAgaW1hZ2Uuc3JjID0gYCR7YmFzZVVybH0/Y2FjaGU9JHtEYXRlLm5vdygpfWA7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBZGRzIGFuIG9ic2lkaWFuIGxpbmsgYW5kIGNsaWNrYWJsZSBpbnNlcnRpb24gaWNvbnMgdG8gdGhlIG91dHB1dC5cclxuICogQHBhcmFtIGZpZ3VyZU5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgZmlndXJlIGZpbGUgd2l0aCBleHRlbnNpb24gdGhhdCB3YXMgc2F2ZWRcclxuICogQHBhcmFtIGZpZ3VyZVBhdGggLSBUaGUgcGF0aCB3aGVyZSB0aGUgZmlndXJlIHdhcyBzYXZlZFxyXG4gKiBAcGFyYW0gb3V0cHV0dGVyIC0gVGhlIE91dHB1dHRlciBpbnN0YW5jZSB1c2VkIHRvIHdyaXRlIGNvbnRlbnRcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3cml0ZUZpbGVMaW5rKGZpZ3VyZU5hbWU6IHN0cmluZywgZmlndXJlUGF0aDogc3RyaW5nLCBvdXRwdXR0ZXI6IE91dHB1dHRlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgb3V0cHV0dGVyLndyaXRlTWFya2Rvd24oYFNhdmVkIFtbJHtmaWd1cmVOYW1lfV1dYCk7XHJcblxyXG4gICAgY29uc3QgaXNUZW1wRmlndXJlID0gVEVNUF9GSUdVUkVfTkFNRS50ZXN0KGZpZ3VyZU5hbWUpO1xyXG4gICAgaWYgKGlzVGVtcEZpZ3VyZSkgcmV0dXJuIG91dHB1dHRlci53cml0ZSgnXFxuJyk7XHJcblxyXG4gICAgY29uc3QgZmlsZTogVEZpbGUgfCBudWxsID0gb3V0cHV0dGVyLmFwcC52YXVsdC5nZXRGaWxlQnlQYXRoKG91dHB1dHRlci5zcmNGaWxlKTtcclxuICAgIGlmICghZmlsZSkgdGhyb3cgbmV3IEVycm9yKGBGaWxlIG5vdCBmb3VuZDogJHtvdXRwdXR0ZXIuc3JjRmlsZX1gKTtcclxuXHJcbiAgICBjb25zdCBsaW5rID0gKCkgPT4gY3JlYXRlT2JzaWRpYW5MaW5rKG91dHB1dHRlci5hcHAsIGZpZ3VyZVBhdGgsIG91dHB1dHRlci5zcmNGaWxlKTtcclxuICAgIGNvbnN0IGZpZ3VyZTogRmlndXJlQ29udGV4dCA9IHsgYXBwOiBvdXRwdXR0ZXIuYXBwLCBmaWd1cmVOYW1lOiBmaWd1cmVOYW1lLCBsaW5rOiBsaW5rLCBmaWxlOiBmaWxlIH07XHJcbiAgICBjb25zdCBidXR0b25DbGFzcyA9ICdpbnNlcnQtZmlndXJlLWljb24nO1xyXG5cclxuICAgIGNvbnN0IGluc2VydEFib3ZlOiBIVE1MQW5jaG9yRWxlbWVudCA9IG91dHB1dHRlci53cml0ZUljb24oJ2ltYWdlLXVwJywgJ0NsaWNrIHRvIGVtYmVkIGZpbGUgYWJvdmUgY29kZWJsb2NrLlxcbkN0cmwgKyBDbGljayB0byByZXBsYWNlIHByZXZpb3VzIGVtYmVkZGluZy4nLCBidXR0b25DbGFzcyk7XHJcbiAgICBpbnNlcnRBYm92ZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChldmVudDogTW91c2VFdmVudCkgPT4gaW5zZXJ0RW1iZWRkaW5nKCdhYm92ZScsIGV2ZW50LmN0cmxLZXksIGZpZ3VyZSkpO1xyXG5cclxuICAgIGNvbnN0IGluc2VydEJlbG93OiBIVE1MQW5jaG9yRWxlbWVudCA9IG91dHB1dHRlci53cml0ZUljb24oJ2ltYWdlLWRvd24nLCAnQ2xpY2sgdG8gZW1iZWQgZmlsZSBiZWxvdyBjb2RlYmxvY2suXFxuQ3RybCArIENsaWNrIHRvIHJlcGxhY2UgbmV4dCBlbWJlZGRpbmcuJywgYnV0dG9uQ2xhc3MpO1xyXG4gICAgaW5zZXJ0QmVsb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IGluc2VydEVtYmVkZGluZygnYmVsb3cnLCBldmVudC5jdHJsS2V5LCBmaWd1cmUpKTtcclxuXHJcbiAgICBjb25zdCBjb3B5TGluazogSFRNTEFuY2hvckVsZW1lbnQgPSBvdXRwdXR0ZXIud3JpdGVJY29uKCdjb3B5JywgJ0NvcHkgdGhlIG1hcmtkb3duIGxpbmsuJywgYnV0dG9uQ2xhc3MpO1xyXG4gICAgY29weUxpbmsuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChsaW5rKCkpKTtcclxuXHJcbiAgICBvdXRwdXR0ZXIud3JpdGUoJ1xcbicpO1xyXG59XHJcblxyXG4vKiogKiBJbnNlcnRzIGFuIGVtYmVkZGVkIGxpbmsgdG8gdGhlIGZpZ3VyZSBhYm92ZSBvciBiZWxvdyB0aGUgY3VycmVudCBjb2RlIGJsb2Nrcy4gKi9cclxuYXN5bmMgZnVuY3Rpb24gaW5zZXJ0RW1iZWRkaW5nKHBhc3RlUG9zaXRpb246ICdhYm92ZScgfCAnYmVsb3cnLCBkb1JlcGxhY2U6IGJvb2xlYW4sIGZpZ3VyZTogRmlndXJlQ29udGV4dCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB2YXVsdCA9IGZpZ3VyZS5hcHAudmF1bHQ7XHJcbiAgICAgICAgY29uc3QgY29udGVudDogc3RyaW5nID0gYXdhaXQgdmF1bHQucmVhZChmaWd1cmUuZmlsZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXJTcmM6IHN0cmluZyA9IHNldHRpbmdzSW5zdGFuY2UubGF0ZXhGaWd1cmVUaXRsZVBhdHRlcm5cclxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcKFxcPzxuYW1lPlteKV0qXFwpLywgZ2VuZXJhbGl6ZUZpZ3VyZVRpdGxlKGZpZ3VyZS5maWd1cmVOYW1lKS5zb3VyY2UpO1xyXG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXI6IFJlZ0V4cCA9IHIucGFyc2UoaWRlbnRpZmllclNyYyk7XHJcbiAgICAgICAgaWYgKCFpZGVudGlmaWVyKSByZXR1cm47XHJcblxyXG4gICAgICAgIGNvbnN0IGNvZGVCbG9ja3M6IFJlZ0V4cEV4ZWNBcnJheVtdID0gZmluZE1hdGNoaW5nQ29kZUJsb2Nrcyhjb250ZW50LCAvKGxhKT90ZXgvLCBpZGVudGlmaWVyLCBmaWd1cmUubGluaygpLCBkb1JlcGxhY2UpO1xyXG4gICAgICAgIGlmIChjb2RlQmxvY2tzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgICBjb2RlQmxvY2tzLmZvckVhY2goYXN5bmMgKGJsb2NrOiBSZWdFeHBFeGVjQXJyYXkpID0+IHtcclxuICAgICAgICAgICAgYXdhaXQgaW5zZXJ0QXRDb2RlQmxvY2soYmxvY2ssIHBhc3RlUG9zaXRpb24sIGZpZ3VyZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluc2VydGluZyBlbWJlZGRpbmc6JywgZXJyb3IpO1xyXG4gICAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKiogTG9jYXRlcyBMYVRlWCBjb2RlIGJsb2NrcyBjb250YWluaW5nIHRoZSBzcGVjaWZpZWQgZmlndXJlIGlkZW50aWZpZXIgYW5kIHRoZWlyIHN1cnJvdW5kaW5nIGVtYmVkZGluZ3MgKi9cclxuZnVuY3Rpb24gZmluZE1hdGNoaW5nQ29kZUJsb2Nrcyhjb250ZW50OiBzdHJpbmcsIGxhbmd1YWdlOiBSZWdFeHAsIGlkZW50aWZpZXI6IFJlZ0V4cCwgbGluazogc3RyaW5nLCBkb1JlcGxhY2U/OiBib29sZWFuKTogUmVnRXhwRXhlY0FycmF5W10ge1xyXG4gICAgY29uc3QgYWxyZWFkeUxpbmtlZDogUmVnRXhwID0gci5ncm91cChyLmVzY2FwZShsaW5rKSk7XHJcbiAgICBjb25zdCBjb2RlYmxvY2s6IFJlZ0V4cCA9IHIuY29uY2F0KFxyXG4gICAgICAgIC9gYGAocnVuLSk/Lywgci5ncm91cChsYW5ndWFnZSksIC9bXFxzXFxuXS8sXHJcbiAgICAgICAgU0FGRV9BTlksIHIuZ3JvdXAoaWRlbnRpZmllciksIFNBRkVfQU5ZLFxyXG4gICAgICAgIC9gYGAvKTtcclxuXHJcbiAgICBjb25zdCBwcmV2aW91czogUmVnRXhwID0gci5jYXB0dXJlKHIuY29uY2F0KEFOWV9GSUdVUkVfRU1CRURESU5HLCBFTVBUWV9MSU5FUyksICdyZXBsYWNlUHJldmlvdXMnKTtcclxuICAgIGNvbnN0IGFib3ZlOiBSZWdFeHAgPSByLmNhcHR1cmUoci5jb25jYXQoYWxyZWFkeUxpbmtlZCwgRU1QVFlfTElORVMpLCAnYWxyZWFkeUFib3ZlJyk7XHJcblxyXG4gICAgY29uc3QgYmVsb3c6IFJlZ0V4cCA9IHIuY2FwdHVyZShyLmNvbmNhdChFTVBUWV9MSU5FUywgYWxyZWFkeUxpbmtlZCksICdhbHJlYWR5QmVsb3cnKTtcclxuICAgIGNvbnN0IG5leHQ6IFJlZ0V4cCA9IHIuY2FwdHVyZShyLmNvbmNhdChFTVBUWV9MSU5FUywgQU5ZX0ZJR1VSRV9FTUJFRERJTkcpLCAncmVwbGFjZU5leHQnKTtcclxuXHJcbiAgICBjb25zdCBibG9ja3NXaXRoRW1iZWRzOiBSZWdFeHAgPSBuZXcgUmVnRXhwKHIuY29uY2F0KFxyXG4gICAgICAgIChkb1JlcGxhY2UpID8gci5vcHRpb25hbChwcmV2aW91cykgOiBudWxsLFxyXG4gICAgICAgIHIub3B0aW9uYWwoYWJvdmUpLFxyXG4gICAgICAgIHIuY2FwdHVyZShjb2RlYmxvY2ssICdjb2RlYmxvY2snKSxcclxuICAgICAgICByLm9wdGlvbmFsKGJlbG93KSxcclxuICAgICAgICAoZG9SZXBsYWNlKSA/IHIub3B0aW9uYWwobmV4dCkgOiBudWxsLFxyXG4gICAgKSwgJ2cnKTtcclxuXHJcbiAgICBjb25zdCBtYXRjaGVzOiBSZWdFeHBFeGVjQXJyYXlbXSA9IEFycmF5LmZyb20oY29udGVudC5tYXRjaEFsbChibG9ja3NXaXRoRW1iZWRzKSk7XHJcbiAgICBjb25zb2xlLmRlYnVnKGBTZWFyY2hpbmcgbWFya2Rvd24gZm9yYCwgYmxvY2tzV2l0aEVtYmVkcywgYHJlc3VsdGVkIGluIGAsIG1hdGNoZXMubGVuZ3RoLCBgY29kZWJsb2NrKHMpYCwgbWF0Y2hlcy5tYXAobWF0Y2ggPT4gbWF0Y2guZ3JvdXBzKSk7XHJcbiAgICByZXR1cm4gbWF0Y2hlcztcclxufVxyXG5cclxuLyoqIFVwZGF0ZXMgbWFya2Rvd24gc291cmNlIGZpbGUgdG8gaW5zZXJ0IG9yIHJlcGxhY2UgYSBmaWd1cmUgZW1iZWRkaW5nIHJlbGF0aXZlIHRvIGEgY29kZSBibG9jayAqL1xyXG5hc3luYyBmdW5jdGlvbiBpbnNlcnRBdENvZGVCbG9jayhibG9jazogUmVnRXhwRXhlY0FycmF5LCBwYXN0ZVBvc2l0aW9uOiAnYWJvdmUnIHwgJ2JlbG93JywgZmlndXJlOiBGaWd1cmVDb250ZXh0KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCB2YXVsdCA9IGZpZ3VyZS5hcHAudmF1bHQ7XHJcbiAgICBjb25zdCBncm91cHMgPSBibG9jay5ncm91cHM7XHJcbiAgICBpZiAoIWdyb3VwcyB8fCAhZ3JvdXBzLmNvZGVibG9jaykgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IGNhblJlcGxhY2U6IEJvb2xlYW4gPSAocGFzdGVQb3NpdGlvbiA9PT0gJ2Fib3ZlJylcclxuICAgICAgICA/IGdyb3Vwcy5yZXBsYWNlUHJldmlvdXM/Lmxlbmd0aCA+IDBcclxuICAgICAgICA6IGdyb3Vwcy5yZXBsYWNlTmV4dD8ubGVuZ3RoID4gMDtcclxuXHJcbiAgICBjb25zdCBpc0FscmVhZHlFbWJlZGRlZDogYm9vbGVhbiA9IChwYXN0ZVBvc2l0aW9uID09PSAnYWJvdmUnKVxyXG4gICAgICAgID8gZ3JvdXBzLmFscmVhZHlBYm92ZT8ubGVuZ3RoID4gMFxyXG4gICAgICAgIDogZ3JvdXBzLmFscmVhZHlCZWxvdz8ubGVuZ3RoID4gMDtcclxuICAgIGlmIChpc0FscmVhZHlFbWJlZGRlZCAmJiAhY2FuUmVwbGFjZSkgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IG5ld1RleHQ6IHN0cmluZyA9IChwYXN0ZVBvc2l0aW9uID09PSAnYWJvdmUnKVxyXG4gICAgICAgID8gZmlndXJlLmxpbmsoKSArICdcXG5cXG4nICsgZ3JvdXBzLmNvZGVibG9ja1xyXG4gICAgICAgIDogZ3JvdXBzLmNvZGVibG9jayArICdcXG5cXG4nICsgZmlndXJlLmxpbmsoKTtcclxuXHJcbiAgICBpZiAoIWNhblJlcGxhY2UpIHtcclxuICAgICAgICBhd2FpdCB2YXVsdC5wcm9jZXNzKGZpZ3VyZS5maWxlLCBkYXRhID0+IGRhdGEucmVwbGFjZShncm91cHMuY29kZWJsb2NrLCBuZXdUZXh0KSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG9sZFRleHRzOiBzdHJpbmdbXSA9IChwYXN0ZVBvc2l0aW9uID09PSAnYWJvdmUnKVxyXG4gICAgICAgID8gW2dyb3Vwcy5yZXBsYWNlUHJldmlvdXMsIGdyb3Vwcy5hbHJlYWR5QWJvdmUsIGdyb3Vwcy5jb2RlYmxvY2tdXHJcbiAgICAgICAgOiBbZ3JvdXBzLmNvZGVibG9jaywgZ3JvdXBzLmFscmVhZHlCZWxvdywgZ3JvdXBzLnJlcGxhY2VOZXh0XTtcclxuICAgIGNvbnN0IG9sZENvbWJpbmVkID0gb2xkVGV4dHMuZmlsdGVyKEJvb2xlYW4pLmpvaW4oJycpO1xyXG4gICAgYXdhaXQgdmF1bHQucHJvY2VzcyhmaWd1cmUuZmlsZSwgZGF0YSA9PiBkYXRhLnJlcGxhY2Uob2xkQ29tYmluZWQsIG5ld1RleHQpKTtcclxufVxyXG5cclxuLyoqIExldCBPYnNpZGlhbiBnZW5lcmF0ZSBhIGxpbmsgYWRoZXJpbmcgdG8gcHJlZmVyZW5jZXMgKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZU9ic2lkaWFuTGluayhhcHA6IEFwcCwgZmlsZVBhdGg6IHN0cmluZywgc291cmNlUGF0aDogc3RyaW5nLCBzdWJwYXRoPzogc3RyaW5nLCBhbGlhcz86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCByZWxhdGl2ZSA9IGdldFBhdGhSZWxhdGl2ZVRvVmF1bHQoZmlsZVBhdGgpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBmaWxlOiBURmlsZSB8IG51bGwgPSBhcHAudmF1bHQuZ2V0RmlsZUJ5UGF0aChyZWxhdGl2ZSk7XHJcbiAgICAgICAgcmV0dXJuIGFwcC5maWxlTWFuYWdlci5nZW5lcmF0ZU1hcmtkb3duTGluayhmaWxlLCBzb3VyY2VQYXRoLCBzdWJwYXRoLCBhbGlhcyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEZpbGUgbm90IGZvdW5kOiAke3JlbGF0aXZlfWApO1xyXG4gICAgICAgIHJldHVybiAnIVtbJyArIHBhdGguYmFzZW5hbWUoZmlsZVBhdGgpICsgJ11dJztcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFBhdGhSZWxhdGl2ZVRvVmF1bHQoYWJzb2x1dGVQYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHZhdWx0UGF0aCA9ICh0aGlzLmFwcC52YXVsdC5hZGFwdGVyIGFzIGFueSkuYmFzZVBhdGg7XHJcbiAgICBhYnNvbHV0ZVBhdGggPSBwYXRoLm5vcm1hbGl6ZShhYnNvbHV0ZVBhdGgpO1xyXG5cclxuICAgIGlmICghYWJzb2x1dGVQYXRoLnN0YXJ0c1dpdGgodmF1bHRQYXRoKSkgcmV0dXJuIGFic29sdXRlUGF0aDtcclxuICAgIHJldHVybiBhYnNvbHV0ZVBhdGguc2xpY2UodmF1bHRQYXRoLmxlbmd0aClcclxuICAgICAgICAucmVwbGFjZSgvXltcXFxcXFwvXS8sICcnKVxyXG4gICAgICAgIC5yZXBsYWNlKC9cXFxcL2csICcvJylcclxuICAgICAgICAucmVwbGFjZSgvWydcImBdLywgJycpXHJcbiAgICAgICAgLnRyaW0oKTtcclxufSJdfQ==