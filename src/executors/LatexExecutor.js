import NonInteractiveCodeExecutor from "./NonInteractiveCodeExecutor";
import * as fs from "fs/promises";
import * as fsSync from "fs";
import * as path from "path";
import { spawn } from "child_process";
import * as os from "os";
import { isStandaloneClass } from "src/transforms/LatexTransformer";
import { updateImage, writeFileLink } from "src/output/LatexInserter";
const REQUEST_RERUN_WARNING = /LaTeX Warning: .* Rerun to get cross-references right./;
const MAX_COMPILER_RERUNS = 10;
export default class LaTeXExecutor extends NonInteractiveCodeExecutor {
    constructor() {
        super(...arguments);
        this.compilerRequestsRerun = new Set;
    }
    /** Main entry point for LaTeX compilation that handles PDF generation and conversion to other formats. */
    async run(latexSrc, outputter, compilerPath, compilerArgs, exportPath) {
        outputter.clear();
        outputter.killBlock = (subprocesses) => this.killSubprocesses(subprocesses);
        const s = this.settings;
        const exec = {
            outputter: outputter,
            outputDir: path.dirname(exportPath),
        };
        const figureName = path.basename(exportPath, path.extname(exportPath));
        const errorHandler = (error) => {
            outputter.writeErr(error + '\n');
            outputter.closeInput();
        };
        // Synchronous compilation
        let pdfFile;
        try {
            exec.workingDir = await this.createTempDirectory(outputter);
            pdfFile = await this.compileAndCrop(latexSrc, compilerArgs, compilerPath, exec);
        }
        catch (error) {
            errorHandler(error);
            this.cleanupBuildDir(exec);
            return;
        }
        // Asynchronous convertion
        if (s.latexSavePdf) {
            this.savePdf(pdfFile, exportPath, `${figureName}.pdf`, exec).catch(errorHandler);
        }
        if (s.latexSaveSvg === "poppler") {
            this.runChildProcess(s.latexSvgPath, [s.latexSvgArgs, pdfFile], `${figureName}.svg`, exec)
                .catch(errorHandler);
        }
        if (s.latexSaveSvg === "inkscape") {
            this.runChildProcess(s.latexInkscapePath, [s.latexInkscapeArgs, pdfFile, '--export-filename'], `${figureName}.svg`, exec)
                .catch(errorHandler);
        }
        if (s.latexSavePng) {
            this.runChildProcess(s.latexPngPath, [s.latexPngArgs, pdfFile], `${figureName}.png`, exec, { outFileArg: figureName })
                .catch(errorHandler);
        }
        this.cleanupBuildDir(exec);
    }
    /** Compiles LaTeX source and crops PDF to content if enabled. */
    async compileAndCrop(latexSrc, compilerArgs, compilerPath, exec) {
        const s = this.settings;
        const buildDir = exec.workingDir;
        const texFile = await this.writeContentToTexFile(latexSrc, buildDir, 'o.tex');
        compilerArgs = [compilerArgs, `-output-directory=${buildDir}`, texFile].join(' ');
        const allowIncludesRelativeToAttachmentDir = { outputDir: buildDir, workingDir: exec.outputDir, outputter: exec.outputter, };
        const cropInBuildDir = { outputDir: buildDir, workingDir: buildDir, outputter: exec.outputter, };
        let pdfFile = await this.compileAndRerun(compilerPath, compilerArgs, allowIncludesRelativeToAttachmentDir);
        if (s.latexKeepLog) {
            const logFile = path.join(buildDir, 'o.log');
            await exec.outputter.writeMarkdown(`Log: [${logFile}](file://${logFile})`, true);
        }
        const isExcludedDocumentclass = s.latexCropNoStandalone && isStandaloneClass(latexSrc);
        if (s.latexDoCrop && !isExcludedDocumentclass) {
            await fs.rename(path.join(buildDir, pdfFile), path.join(buildDir, 'original.pdf'));
            pdfFile = await this.runChildProcess(s.latexCropPath, [s.latexCropArgs, 'original.pdf'], pdfFile, cropInBuildDir, { skipWriteFileLink: true });
        }
        return pdfFile;
    }
    /** Handles LaTeX compilation with automatic reruns for cross-references. */
    async compileAndRerun(compilerPath, args, exec) {
        for (let attempt = 0; attempt <= MAX_COMPILER_RERUNS; attempt++) {
            const isLastAttempt = attempt == MAX_COMPILER_RERUNS;
            const result = await this.runChildProcess(compilerPath, args.split(' '), 'o.pdf', exec, { skipWriteFileLink: true, outFileArg: "", doDetectRerun: !isLastAttempt });
            const hasRequestedRerun = result === undefined;
            if (!hasRequestedRerun)
                return result;
        }
        throw `LaTeX compilation did not result in a PDF file.`;
    }
    /** Stop running child processes on clicking Clear or Run again. */
    killSubprocesses(subprocesses) {
        for (const child of subprocesses) {
            child.kill('SIGINT');
            console.log(`Subprocess ${path.basename(child.spawnfile)} killed.`);
            subprocesses.delete(child);
        }
    }
    /** Save PDF as vault attachment */
    async savePdf(pdfFile, exportPath, figureName, exec) {
        const pdfPath = path.join(exec.workingDir, pdfFile);
        const destinationPath = `${exportPath}.pdf`;
        try {
            await fs.copyFile(pdfPath, destinationPath);
        }
        catch (error) {
            throw `Failed to copy ${pdfPath} to ${destinationPath}: ${error}`;
        }
        await writeFileLink(figureName, destinationPath, exec.outputter);
    }
    /** Executes a child process and capture its output. */
    async runChildProcess(cmd, args, outName, exec, options) {
        const outDir = exec.outputDir;
        const cwdDir = exec.workingDir;
        const outputter = exec.outputter;
        let outFileArg = (options === null || options === void 0 ? void 0 : options.outFileArg) || outName;
        const outFile = path.join(outDir, outFileArg);
        if (outFileArg) {
            if (outDir !== cwdDir) {
                outFileArg = outFile;
            }
            args.push(`"${outFileArg}"`);
        }
        const child = spawn(cmd, args, {
            env: process.env,
            windowsVerbatimArguments: true,
            cwd: cwdDir,
            shell: Boolean(this.settings.latexSubprocessesUseShell)
        });
        outputter.runningSubprocesses.add(child);
        const description = `Subprocess ${cmd} ${args.join(" ")}`;
        child.stdout.on('data', (data) => outputter.write(data.toString()));
        child.stderr.on('data', (data) => outputter.writeErr(data.toString()));
        outputter.on('data', (data) => child.stdin.write(data));
        if (options === null || options === void 0 ? void 0 : options.doDetectRerun) {
            child.stdout.on('data', (data) => this.detectWarningRequestingRerun(data, child));
        }
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (!outputter.runningSubprocesses.has(child))
                    return;
                child.kill('SIGTERM');
                reject(new Error(`${description} timed out after ${this.settings.timeout} ms.`));
            }, this.settings.timeout);
            child.on('error', (err) => reject(`${description} throws:\n${err}`));
            child.on('close', async (code) => {
                const resultedInFile = fsSync.existsSync(path.join(outDir, outName));
                outputter.runningSubprocesses.delete(child);
                if (code != 0)
                    return reject(`${description} failed with code ${code}.`);
                if (!resultedInFile)
                    return reject(`${description} failed to create ${outFile}.`);
                if ((options === null || options === void 0 ? void 0 : options.doDetectRerun) && this.compilerRequestsRerun.has(child)) {
                    this.compilerRequestsRerun.delete(child);
                    return resolve(undefined);
                }
                if (options === null || options === void 0 ? void 0 : options.skipWriteFileLink)
                    return resolve(outName);
                const figureEmbeddings = document.querySelectorAll(`img[alt="${outName}"]`);
                figureEmbeddings.forEach(img => updateImage(img));
                await writeFileLink(outName, path.join(outDir, outName), outputter);
                await sleep(200); // Wait for obsidian to index attachment
                if (this.settings.latexOutputEmbeddings) {
                    await outputter.writeMarkdown(`![[${outName}]]`, true);
                }
                outputter.closeInput();
                return resolve(outName);
            });
        });
    }
    /** Checks LaTeX output for warnings indicating need for additional compilation pass */
    detectWarningRequestingRerun(data, child) {
        if (REQUEST_RERUN_WARNING.test(data.toString())) {
            this.compilerRequestsRerun.add(child);
        }
        ;
    }
    async writeContentToTexFile(codeBlockContent, buildDir, filename) {
        const texFile = path.join(buildDir, filename);
        await fs.writeFile(texFile, codeBlockContent);
        return filename;
    }
    /** Creates a unique temporary directory for the current LaTeX compilation */
    async createTempDirectory(outputter) {
        const millisToday = Date.now() - new Date().setHours(0, 0, 0, 0);
        const prefix = "tex" + millisToday.toString();
        const prefixPath = path.join(os.tmpdir(), prefix);
        const buildDir = await fs.mkdtemp(prefixPath);
        this.removeBuildDir = async () => {
            const success = await this.removeLockedFolder(buildDir);
            if (success)
                outputter.closeInput();
        };
        return buildDir;
    }
    /** Attempts to clean up the build directory with retry logic for locked files */
    async cleanupBuildDir(exec) {
        const path = exec.workingDir;
        if (!path || this.settings.latexKeepLog)
            return;
        await sleep(100); // Wait for subprocesses to start
        if (!fsSync.existsSync(path))
            return;
        const maxRetries = 10;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            await sleep(500); // Wait for subprocesses to unlock folder
            if (!fsSync.existsSync(path))
                return;
            if (exec.outputter.runningSubprocesses.size > 0)
                continue;
            const success = await this.removeLockedFolder(path, `Build folder busy, retrying (${attempt + 1}/${maxRetries}).`);
            if (success) {
                exec.outputter.closeInput();
                return;
            }
        }
        throw new Error('Failed to delete folder after multiple attempts.');
    }
    /** Safely removes a directory that might be locked by the system */
    async removeLockedFolder(path, comment) {
        try {
            await fs.rmdir(path, { recursive: true });
            console.debug(`Removed build folder: ${path}`);
            return true;
        }
        catch (error) {
            if (error.code != 'EBUSY' && error.code != 'ENOENT')
                throw error;
            if (comment) {
                console.log(comment);
            }
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF0ZXhFeGVjdXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkxhdGV4RXhlY3V0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTywwQkFBMEIsTUFBTSw4QkFBOEIsQ0FBQztBQUV0RSxPQUFPLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNsQyxPQUFPLEtBQUssTUFBTSxNQUFNLElBQUksQ0FBQztBQUM3QixPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQWdCLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXRFLE1BQU0scUJBQXFCLEdBQVcsd0RBQXdELENBQUE7QUFDOUYsTUFBTSxtQkFBbUIsR0FBRyxFQUFFLENBQUM7QUFRL0IsTUFBTSxDQUFDLE9BQU8sT0FBTyxhQUFjLFNBQVEsMEJBQTBCO0lBQXJFOztRQUNJLDBCQUFxQixHQUFHLElBQUksR0FBaUIsQ0FBQztJQXlPbEQsQ0FBQztJQXRPRywwR0FBMEc7SUFDMUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFnQixFQUFFLFNBQW9CLEVBQUUsWUFBb0IsRUFBRSxZQUFvQixFQUFFLFVBQWtCO1FBQzVHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNsQixTQUFTLENBQUMsU0FBUyxHQUFHLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDNUUsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUN4QixNQUFNLElBQUksR0FBcUI7WUFDM0IsU0FBUyxFQUFFLFNBQVM7WUFDcEIsU0FBUyxFQUFFLElB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O0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTm9uSW50ZXJhY3RpdmVDb2RlRXhlY3V0b3IgZnJvbSBcIi4vTm9uSW50ZXJhY3RpdmVDb2RlRXhlY3V0b3JcIjtcclxuaW1wb3J0IHsgT3V0cHV0dGVyIH0gZnJvbSBcIi4uL291dHB1dC9PdXRwdXR0ZXJcIjtcclxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzL3Byb21pc2VzXCI7XHJcbmltcG9ydCAqIGFzIGZzU3luYyBmcm9tIFwiZnNcIjtcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xyXG5pbXBvcnQgeyBDaGlsZFByb2Nlc3MsIHNwYXduIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcclxuaW1wb3J0ICogYXMgb3MgZnJvbSBcIm9zXCI7XHJcbmltcG9ydCB7IGlzU3RhbmRhbG9uZUNsYXNzIH0gZnJvbSBcInNyYy90cmFuc2Zvcm1zL0xhdGV4VHJhbnNmb3JtZXJcIjtcclxuaW1wb3J0IHsgdXBkYXRlSW1hZ2UsIHdyaXRlRmlsZUxpbmsgfSBmcm9tIFwic3JjL291dHB1dC9MYXRleEluc2VydGVyXCI7XHJcblxyXG5jb25zdCBSRVFVRVNUX1JFUlVOX1dBUk5JTkc6IFJlZ0V4cCA9IC9MYVRlWCBXYXJuaW5nOiAuKiBSZXJ1biB0byBnZXQgY3Jvc3MtcmVmZXJlbmNlcyByaWdodC4vXHJcbmNvbnN0IE1BWF9DT01QSUxFUl9SRVJVTlMgPSAxMDtcclxuXHJcbmludGVyZmFjZSBFeGVjdXRpb25Db250ZXh0IHtcclxuICAgIHdvcmtpbmdEaXI/OiBzdHJpbmc7XHJcbiAgICBvdXRwdXREaXI6IHN0cmluZztcclxuICAgIG91dHB1dHRlcjogT3V0cHV0dGVyO1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYVRlWEV4ZWN1dG9yIGV4dGVuZHMgTm9uSW50ZXJhY3RpdmVDb2RlRXhlY3V0b3Ige1xyXG4gICAgY29tcGlsZXJSZXF1ZXN0c1JlcnVuID0gbmV3IFNldDxDaGlsZFByb2Nlc3M+O1xyXG4gICAgcmVtb3ZlQnVpbGREaXI6ICgpID0+IHZvaWQ7XHJcblxyXG4gICAgLyoqIE1haW4gZW50cnkgcG9pbnQgZm9yIExhVGVYIGNvbXBpbGF0aW9uIHRoYXQgaGFuZGxlcyBQREYgZ2VuZXJhdGlvbiBhbmQgY29udmVyc2lvbiB0byBvdGhlciBmb3JtYXRzLiAqL1xyXG4gICAgYXN5bmMgcnVuKGxhdGV4U3JjOiBzdHJpbmcsIG91dHB1dHRlcjogT3V0cHV0dGVyLCBjb21waWxlclBhdGg6IHN0cmluZywgY29tcGlsZXJBcmdzOiBzdHJpbmcsIGV4cG9ydFBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIG91dHB1dHRlci5jbGVhcigpO1xyXG4gICAgICAgIG91dHB1dHRlci5raWxsQmxvY2sgPSAoc3VicHJvY2Vzc2VzKSA9PiB0aGlzLmtpbGxTdWJwcm9jZXNzZXMoc3VicHJvY2Vzc2VzKTtcclxuICAgICAgICBjb25zdCBzID0gdGhpcy5zZXR0aW5ncztcclxuICAgICAgICBjb25zdCBleGVjOiBFeGVjdXRpb25Db250ZXh0ID0ge1xyXG4gICAgICAgICAgICBvdXRwdXR0ZXI6IG91dHB1dHRlcixcclxuICAgICAgICAgICAgb3V0cHV0RGlyOiBwYXRoLmRpcm5hbWUoZXhwb3J0UGF0aCksXHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBmaWd1cmVOYW1lID0gcGF0aC5iYXNlbmFtZShleHBvcnRQYXRoLCBwYXRoLmV4dG5hbWUoZXhwb3J0UGF0aCkpO1xyXG4gICAgICAgIGNvbnN0IGVycm9ySGFuZGxlciA9IChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIG91dHB1dHRlci53cml0ZUVycihlcnJvciArICdcXG4nKTtcclxuICAgICAgICAgICAgb3V0cHV0dGVyLmNsb3NlSW5wdXQoKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBTeW5jaHJvbm91cyBjb21waWxhdGlvblxyXG4gICAgICAgIGxldCBwZGZGaWxlOiBzdHJpbmc7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZXhlYy53b3JraW5nRGlyID0gYXdhaXQgdGhpcy5jcmVhdGVUZW1wRGlyZWN0b3J5KG91dHB1dHRlcik7XHJcbiAgICAgICAgICAgIHBkZkZpbGUgPSBhd2FpdCB0aGlzLmNvbXBpbGVBbmRDcm9wKGxhdGV4U3JjLCBjb21waWxlckFyZ3MsIGNvbXBpbGVyUGF0aCwgZXhlYyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgZXJyb3JIYW5kbGVyKGVycm9yKTtcclxuICAgICAgICAgICAgdGhpcy5jbGVhbnVwQnVpbGREaXIoZXhlYyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEFzeW5jaHJvbm91cyBjb252ZXJ0aW9uXHJcbiAgICAgICAgaWYgKHMubGF0ZXhTYXZlUGRmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2F2ZVBkZihwZGZGaWxlLCBleHBvcnRQYXRoLCBgJHtmaWd1cmVOYW1lfS5wZGZgLCBleGVjKS5jYXRjaChlcnJvckhhbmRsZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocy5sYXRleFNhdmVTdmcgPT09IFwicG9wcGxlclwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnVuQ2hpbGRQcm9jZXNzKHMubGF0ZXhTdmdQYXRoLCBbcy5sYXRleFN2Z0FyZ3MsIHBkZkZpbGVdLCBgJHtmaWd1cmVOYW1lfS5zdmdgLCBleGVjKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVycm9ySGFuZGxlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzLmxhdGV4U2F2ZVN2ZyA9PT0gXCJpbmtzY2FwZVwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnVuQ2hpbGRQcm9jZXNzKHMubGF0ZXhJbmtzY2FwZVBhdGgsIFtzLmxhdGV4SW5rc2NhcGVBcmdzLCBwZGZGaWxlLCAnLS1leHBvcnQtZmlsZW5hbWUnXSwgYCR7ZmlndXJlTmFtZX0uc3ZnYCwgZXhlYylcclxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvckhhbmRsZXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocy5sYXRleFNhdmVQbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5ydW5DaGlsZFByb2Nlc3Mocy5sYXRleFBuZ1BhdGgsIFtzLmxhdGV4UG5nQXJncywgcGRmRmlsZV0sIGAke2ZpZ3VyZU5hbWV9LnBuZ2AsIGV4ZWMsIHsgb3V0RmlsZUFyZzogZmlndXJlTmFtZSB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVycm9ySGFuZGxlcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmNsZWFudXBCdWlsZERpcihleGVjKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogQ29tcGlsZXMgTGFUZVggc291cmNlIGFuZCBjcm9wcyBQREYgdG8gY29udGVudCBpZiBlbmFibGVkLiAqL1xyXG4gICAgcHJpdmF0ZSBhc3luYyBjb21waWxlQW5kQ3JvcChsYXRleFNyYzogc3RyaW5nLCBjb21waWxlckFyZ3M6IHN0cmluZywgY29tcGlsZXJQYXRoOiBzdHJpbmcsIGV4ZWM6IEV4ZWN1dGlvbkNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBzID0gdGhpcy5zZXR0aW5ncztcclxuICAgICAgICBjb25zdCBidWlsZERpciA9IGV4ZWMud29ya2luZ0RpcjtcclxuICAgICAgICBjb25zdCB0ZXhGaWxlID0gYXdhaXQgdGhpcy53cml0ZUNvbnRlbnRUb1RleEZpbGUobGF0ZXhTcmMsIGJ1aWxkRGlyLCAnby50ZXgnKTtcclxuICAgICAgICBjb21waWxlckFyZ3MgPSBbY29tcGlsZXJBcmdzLCBgLW91dHB1dC1kaXJlY3Rvcnk9JHtidWlsZERpcn1gLCB0ZXhGaWxlXS5qb2luKCcgJyk7XHJcbiAgICAgICAgY29uc3QgYWxsb3dJbmNsdWRlc1JlbGF0aXZlVG9BdHRhY2htZW50RGlyOiBFeGVjdXRpb25Db250ZXh0ID0geyBvdXRwdXREaXI6IGJ1aWxkRGlyLCB3b3JraW5nRGlyOiBleGVjLm91dHB1dERpciwgb3V0cHV0dGVyOiBleGVjLm91dHB1dHRlciwgfVxyXG4gICAgICAgIGNvbnN0IGNyb3BJbkJ1aWxkRGlyOiBFeGVjdXRpb25Db250ZXh0ID0geyBvdXRwdXREaXI6IGJ1aWxkRGlyLCB3b3JraW5nRGlyOiBidWlsZERpciwgb3V0cHV0dGVyOiBleGVjLm91dHB1dHRlciwgfVxyXG5cclxuICAgICAgICBsZXQgcGRmRmlsZSA9IGF3YWl0IHRoaXMuY29tcGlsZUFuZFJlcnVuKGNvbXBpbGVyUGF0aCwgY29tcGlsZXJBcmdzLCBhbGxvd0luY2x1ZGVzUmVsYXRpdmVUb0F0dGFjaG1lbnREaXIpO1xyXG4gICAgICAgIGlmIChzLmxhdGV4S2VlcExvZykge1xyXG4gICAgICAgICAgICBjb25zdCBsb2dGaWxlID0gcGF0aC5qb2luKGJ1aWxkRGlyLCAnby5sb2cnKTtcclxuICAgICAgICAgICAgYXdhaXQgZXhlYy5vdXRwdXR0ZXIud3JpdGVNYXJrZG93bihgTG9nOiBbJHtsb2dGaWxlfV0oZmlsZTovLyR7bG9nRmlsZX0pYCwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGlzRXhjbHVkZWREb2N1bWVudGNsYXNzID0gcy5sYXRleENyb3BOb1N0YW5kYWxvbmUgJiYgaXNTdGFuZGFsb25lQ2xhc3MobGF0ZXhTcmMpO1xyXG4gICAgICAgIGlmIChzLmxhdGV4RG9Dcm9wICYmICFpc0V4Y2x1ZGVkRG9jdW1lbnRjbGFzcykge1xyXG4gICAgICAgICAgICBhd2FpdCBmcy5yZW5hbWUocGF0aC5qb2luKGJ1aWxkRGlyLCBwZGZGaWxlKSwgcGF0aC5qb2luKGJ1aWxkRGlyLCAnb3JpZ2luYWwucGRmJykpO1xyXG4gICAgICAgICAgICBwZGZGaWxlID0gYXdhaXQgdGhpcy5ydW5DaGlsZFByb2Nlc3Mocy5sYXRleENyb3BQYXRoLCBbcy5sYXRleENyb3BBcmdzLCAnb3JpZ2luYWwucGRmJ10sIHBkZkZpbGUsIGNyb3BJbkJ1aWxkRGlyLCB7IHNraXBXcml0ZUZpbGVMaW5rOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGRmRmlsZTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogSGFuZGxlcyBMYVRlWCBjb21waWxhdGlvbiB3aXRoIGF1dG9tYXRpYyByZXJ1bnMgZm9yIGNyb3NzLXJlZmVyZW5jZXMuICovXHJcbiAgICBwcml2YXRlIGFzeW5jIGNvbXBpbGVBbmRSZXJ1bihjb21waWxlclBhdGg6IHN0cmluZywgYXJnczogc3RyaW5nLCBleGVjOiBFeGVjdXRpb25Db250ZXh0KTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgICAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8PSBNQVhfQ09NUElMRVJfUkVSVU5TOyBhdHRlbXB0KyspIHtcclxuICAgICAgICAgICAgY29uc3QgaXNMYXN0QXR0ZW1wdCA9IGF0dGVtcHQgPT0gTUFYX0NPTVBJTEVSX1JFUlVOUztcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5ydW5DaGlsZFByb2Nlc3MoY29tcGlsZXJQYXRoLCBhcmdzLnNwbGl0KCcgJyksICdvLnBkZicsIGV4ZWMsIHsgc2tpcFdyaXRlRmlsZUxpbms6IHRydWUsIG91dEZpbGVBcmc6IFwiXCIsIGRvRGV0ZWN0UmVydW46ICFpc0xhc3RBdHRlbXB0IH0pO1xyXG4gICAgICAgICAgICBjb25zdCBoYXNSZXF1ZXN0ZWRSZXJ1biA9IHJlc3VsdCA9PT0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBpZiAoIWhhc1JlcXVlc3RlZFJlcnVuKSByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aHJvdyBgTGFUZVggY29tcGlsYXRpb24gZGlkIG5vdCByZXN1bHQgaW4gYSBQREYgZmlsZS5gO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBTdG9wIHJ1bm5pbmcgY2hpbGQgcHJvY2Vzc2VzIG9uIGNsaWNraW5nIENsZWFyIG9yIFJ1biBhZ2Fpbi4gKi9cclxuICAgIHByaXZhdGUga2lsbFN1YnByb2Nlc3NlcyhzdWJwcm9jZXNzZXM6IFNldDxDaGlsZFByb2Nlc3M+KSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiBzdWJwcm9jZXNzZXMpIHtcclxuICAgICAgICAgICAgY2hpbGQua2lsbCgnU0lHSU5UJyk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTdWJwcm9jZXNzICR7cGF0aC5iYXNlbmFtZShjaGlsZC5zcGF3bmZpbGUpfSBraWxsZWQuYCk7XHJcbiAgICAgICAgICAgIHN1YnByb2Nlc3Nlcy5kZWxldGUoY2hpbGQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogU2F2ZSBQREYgYXMgdmF1bHQgYXR0YWNobWVudCAqL1xyXG4gICAgcHJpdmF0ZSBhc3luYyBzYXZlUGRmKHBkZkZpbGU6IHN0cmluZywgZXhwb3J0UGF0aDogc3RyaW5nLCBmaWd1cmVOYW1lOiBzdHJpbmcsIGV4ZWM6IEV4ZWN1dGlvbkNvbnRleHQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCBwZGZQYXRoID0gcGF0aC5qb2luKGV4ZWMud29ya2luZ0RpciwgcGRmRmlsZSk7XHJcbiAgICAgICAgY29uc3QgZGVzdGluYXRpb25QYXRoID0gYCR7ZXhwb3J0UGF0aH0ucGRmYDtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgZnMuY29weUZpbGUocGRmUGF0aCwgZGVzdGluYXRpb25QYXRoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyBgRmFpbGVkIHRvIGNvcHkgJHtwZGZQYXRofSB0byAke2Rlc3RpbmF0aW9uUGF0aH06ICR7ZXJyb3J9YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGF3YWl0IHdyaXRlRmlsZUxpbmsoZmlndXJlTmFtZSwgZGVzdGluYXRpb25QYXRoLCBleGVjLm91dHB1dHRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIEV4ZWN1dGVzIGEgY2hpbGQgcHJvY2VzcyBhbmQgY2FwdHVyZSBpdHMgb3V0cHV0LiAqL1xyXG4gICAgcHJpdmF0ZSBhc3luYyBydW5DaGlsZFByb2Nlc3MoY21kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdLCBvdXROYW1lOiBzdHJpbmcsIGV4ZWM6IEV4ZWN1dGlvbkNvbnRleHQsIG9wdGlvbnM/OiB7IG91dEZpbGVBcmc/OiBzdHJpbmcsIHNraXBXcml0ZUZpbGVMaW5rPzogYm9vbGVhbiwgZG9EZXRlY3RSZXJ1bj86IGJvb2xlYW4gfSk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XHJcbiAgICAgICAgY29uc3Qgb3V0RGlyID0gZXhlYy5vdXRwdXREaXI7XHJcbiAgICAgICAgY29uc3QgY3dkRGlyID0gZXhlYy53b3JraW5nRGlyO1xyXG4gICAgICAgIGNvbnN0IG91dHB1dHRlciA9IGV4ZWMub3V0cHV0dGVyO1xyXG4gICAgICAgIGxldCBvdXRGaWxlQXJnOiBzdHJpbmcgPSBvcHRpb25zPy5vdXRGaWxlQXJnIHx8IG91dE5hbWU7XHJcbiAgICAgICAgY29uc3Qgb3V0RmlsZSA9IHBhdGguam9pbihvdXREaXIsIG91dEZpbGVBcmcpO1xyXG4gICAgICAgIGlmIChvdXRGaWxlQXJnKSB7XHJcbiAgICAgICAgICAgIGlmIChvdXREaXIgIT09IGN3ZERpcikge1xyXG4gICAgICAgICAgICAgICAgb3V0RmlsZUFyZyA9IG91dEZpbGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXJncy5wdXNoKGBcIiR7b3V0RmlsZUFyZ31cImApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY2hpbGQgPSBzcGF3bihjbWQsIGFyZ3MsIHtcclxuICAgICAgICAgICAgZW52OiBwcm9jZXNzLmVudixcclxuICAgICAgICAgICAgd2luZG93c1ZlcmJhdGltQXJndW1lbnRzOiB0cnVlLFxyXG4gICAgICAgICAgICBjd2Q6IGN3ZERpcixcclxuICAgICAgICAgICAgc2hlbGw6IEJvb2xlYW4odGhpcy5zZXR0aW5ncy5sYXRleFN1YnByb2Nlc3Nlc1VzZVNoZWxsKVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG91dHB1dHRlci5ydW5uaW5nU3VicHJvY2Vzc2VzLmFkZChjaGlsZCk7XHJcbiAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSBgU3VicHJvY2VzcyAke2NtZH0gJHthcmdzLmpvaW4oXCIgXCIpfWA7XHJcblxyXG5cclxuICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YSkgPT4gb3V0cHV0dGVyLndyaXRlKGRhdGEudG9TdHJpbmcoKSkpO1xyXG4gICAgICAgIGNoaWxkLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiBvdXRwdXR0ZXIud3JpdGVFcnIoZGF0YS50b1N0cmluZygpKSk7XHJcbiAgICAgICAgb3V0cHV0dGVyLm9uKCdkYXRhJywgKGRhdGEpID0+IGNoaWxkLnN0ZGluLndyaXRlKGRhdGEpKTtcclxuICAgICAgICBpZiAob3B0aW9ucz8uZG9EZXRlY3RSZXJ1bikge1xyXG4gICAgICAgICAgICBjaGlsZC5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YSkgPT4gdGhpcy5kZXRlY3RXYXJuaW5nUmVxdWVzdGluZ1JlcnVuKGRhdGEsIGNoaWxkKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghb3V0cHV0dGVyLnJ1bm5pbmdTdWJwcm9jZXNzZXMuaGFzKGNoaWxkKSkgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgY2hpbGQua2lsbCgnU0lHVEVSTScpO1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgJHtkZXNjcmlwdGlvbn0gdGltZWQgb3V0IGFmdGVyICR7dGhpcy5zZXR0aW5ncy50aW1lb3V0fSBtcy5gKSk7XHJcbiAgICAgICAgICAgIH0sIHRoaXMuc2V0dGluZ3MudGltZW91dCk7XHJcblxyXG4gICAgICAgICAgICBjaGlsZC5vbignZXJyb3InLCAoZXJyKSA9PiByZWplY3QoYCR7ZGVzY3JpcHRpb259IHRocm93czpcXG4ke2Vycn1gKSk7XHJcbiAgICAgICAgICAgIGNoaWxkLm9uKCdjbG9zZScsIGFzeW5jIChjb2RlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRlZEluRmlsZSA9IGZzU3luYy5leGlzdHNTeW5jKHBhdGguam9pbihvdXREaXIsIG91dE5hbWUpKTtcclxuICAgICAgICAgICAgICAgIG91dHB1dHRlci5ydW5uaW5nU3VicHJvY2Vzc2VzLmRlbGV0ZShjaGlsZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGNvZGUgIT0gMCkgcmV0dXJuIHJlamVjdChgJHtkZXNjcmlwdGlvbn0gZmFpbGVkIHdpdGggY29kZSAke2NvZGV9LmApO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHRlZEluRmlsZSkgcmV0dXJuIHJlamVjdChgJHtkZXNjcmlwdGlvbn0gZmFpbGVkIHRvIGNyZWF0ZSAke291dEZpbGV9LmApO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zPy5kb0RldGVjdFJlcnVuICYmIHRoaXMuY29tcGlsZXJSZXF1ZXN0c1JlcnVuLmhhcyhjaGlsZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBpbGVyUmVxdWVzdHNSZXJ1bi5kZWxldGUoY2hpbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnM/LnNraXBXcml0ZUZpbGVMaW5rKSByZXR1cm4gcmVzb2x2ZShvdXROYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZpZ3VyZUVtYmVkZGluZ3M6IE5vZGVMaXN0T2Y8SFRNTEltYWdlRWxlbWVudD4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGBpbWdbYWx0PVwiJHtvdXROYW1lfVwiXWApO1xyXG4gICAgICAgICAgICAgICAgZmlndXJlRW1iZWRkaW5ncy5mb3JFYWNoKGltZyA9PiB1cGRhdGVJbWFnZShpbWcpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBhd2FpdCB3cml0ZUZpbGVMaW5rKG91dE5hbWUsIHBhdGguam9pbihvdXREaXIsIG91dE5hbWUpLCBvdXRwdXR0ZXIpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgc2xlZXAoMjAwKTsgLy8gV2FpdCBmb3Igb2JzaWRpYW4gdG8gaW5kZXggYXR0YWNobWVudFxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MubGF0ZXhPdXRwdXRFbWJlZGRpbmdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3V0cHV0dGVyLndyaXRlTWFya2Rvd24oYCFbWyR7b3V0TmFtZX1dXWAsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgb3V0cHV0dGVyLmNsb3NlSW5wdXQoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKG91dE5hbWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogQ2hlY2tzIExhVGVYIG91dHB1dCBmb3Igd2FybmluZ3MgaW5kaWNhdGluZyBuZWVkIGZvciBhZGRpdGlvbmFsIGNvbXBpbGF0aW9uIHBhc3MgKi9cclxuICAgIHByaXZhdGUgZGV0ZWN0V2FybmluZ1JlcXVlc3RpbmdSZXJ1bihkYXRhOiBhbnksIGNoaWxkOiBDaGlsZFByb2Nlc3MpIHtcclxuICAgICAgICBpZiAoUkVRVUVTVF9SRVJVTl9XQVJOSU5HLnRlc3QoZGF0YS50b1N0cmluZygpKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbXBpbGVyUmVxdWVzdHNSZXJ1bi5hZGQoY2hpbGQpO1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyB3cml0ZUNvbnRlbnRUb1RleEZpbGUoY29kZUJsb2NrQ29udGVudDogc3RyaW5nLCBidWlsZERpcjogc3RyaW5nLCBmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgICAgICBjb25zdCB0ZXhGaWxlID0gcGF0aC5qb2luKGJ1aWxkRGlyLCBmaWxlbmFtZSlcclxuICAgICAgICBhd2FpdCBmcy53cml0ZUZpbGUodGV4RmlsZSwgY29kZUJsb2NrQ29udGVudCk7XHJcbiAgICAgICAgcmV0dXJuIGZpbGVuYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBDcmVhdGVzIGEgdW5pcXVlIHRlbXBvcmFyeSBkaXJlY3RvcnkgZm9yIHRoZSBjdXJyZW50IExhVGVYIGNvbXBpbGF0aW9uICovXHJcbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZVRlbXBEaXJlY3Rvcnkob3V0cHV0dGVyOiBPdXRwdXR0ZXIpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgICAgIGNvbnN0IG1pbGxpc1RvZGF5ID0gRGF0ZS5ub3coKSAtIG5ldyBEYXRlKCkuc2V0SG91cnMoMCwgMCwgMCwgMCk7XHJcbiAgICAgICAgY29uc3QgcHJlZml4ID0gXCJ0ZXhcIiArIG1pbGxpc1RvZGF5LnRvU3RyaW5nKCk7XHJcbiAgICAgICAgY29uc3QgcHJlZml4UGF0aCA9IHBhdGguam9pbihvcy50bXBkaXIoKSwgcHJlZml4KVxyXG4gICAgICAgIGNvbnN0IGJ1aWxkRGlyID0gYXdhaXQgZnMubWtkdGVtcChwcmVmaXhQYXRoKTtcclxuICAgICAgICB0aGlzLnJlbW92ZUJ1aWxkRGlyID0gYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQgdGhpcy5yZW1vdmVMb2NrZWRGb2xkZXIoYnVpbGREaXIpO1xyXG4gICAgICAgICAgICBpZiAoc3VjY2Vzcykgb3V0cHV0dGVyLmNsb3NlSW5wdXQoKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBidWlsZERpcjtcclxuICAgIH1cclxuXHJcbiAgICAvKiogQXR0ZW1wdHMgdG8gY2xlYW4gdXAgdGhlIGJ1aWxkIGRpcmVjdG9yeSB3aXRoIHJldHJ5IGxvZ2ljIGZvciBsb2NrZWQgZmlsZXMgKi9cclxuICAgIHByaXZhdGUgYXN5bmMgY2xlYW51cEJ1aWxkRGlyKGV4ZWM6IEV4ZWN1dGlvbkNvbnRleHQpIHtcclxuICAgICAgICBjb25zdCBwYXRoOiBzdHJpbmcgfCBudWxsID0gZXhlYy53b3JraW5nRGlyO1xyXG4gICAgICAgIGlmICghcGF0aCB8fCB0aGlzLnNldHRpbmdzLmxhdGV4S2VlcExvZykgcmV0dXJuO1xyXG5cclxuICAgICAgICBhd2FpdCBzbGVlcCgxMDApOyAvLyBXYWl0IGZvciBzdWJwcm9jZXNzZXMgdG8gc3RhcnRcclxuICAgICAgICBpZiAoIWZzU3luYy5leGlzdHNTeW5jKHBhdGgpKSByZXR1cm47XHJcblxyXG4gICAgICAgIGNvbnN0IG1heFJldHJpZXMgPSAxMDtcclxuICAgICAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IG1heFJldHJpZXM7IGF0dGVtcHQrKykge1xyXG4gICAgICAgICAgICBhd2FpdCBzbGVlcCg1MDApOyAvLyBXYWl0IGZvciBzdWJwcm9jZXNzZXMgdG8gdW5sb2NrIGZvbGRlclxyXG4gICAgICAgICAgICBpZiAoIWZzU3luYy5leGlzdHNTeW5jKHBhdGgpKSByZXR1cm47XHJcbiAgICAgICAgICAgIGlmIChleGVjLm91dHB1dHRlci5ydW5uaW5nU3VicHJvY2Vzc2VzLnNpemUgPiAwKSBjb250aW51ZTtcclxuICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IHRoaXMucmVtb3ZlTG9ja2VkRm9sZGVyKHBhdGgsIGBCdWlsZCBmb2xkZXIgYnVzeSwgcmV0cnlpbmcgKCR7YXR0ZW1wdCArIDF9LyR7bWF4UmV0cmllc30pLmApO1xyXG4gICAgICAgICAgICBpZiAoc3VjY2Vzcykge1xyXG4gICAgICAgICAgICAgICAgZXhlYy5vdXRwdXR0ZXIuY2xvc2VJbnB1dCgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGRlbGV0ZSBmb2xkZXIgYWZ0ZXIgbXVsdGlwbGUgYXR0ZW1wdHMuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFNhZmVseSByZW1vdmVzIGEgZGlyZWN0b3J5IHRoYXQgbWlnaHQgYmUgbG9ja2VkIGJ5IHRoZSBzeXN0ZW0gKi9cclxuICAgIHByaXZhdGUgYXN5bmMgcmVtb3ZlTG9ja2VkRm9sZGVyKHBhdGg6IHN0cmluZywgY29tbWVudD86IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGZzLnJtZGlyKHBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBSZW1vdmVkIGJ1aWxkIGZvbGRlcjogJHtwYXRofWApO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IuY29kZSAhPSAnRUJVU1knICYmIGVycm9yLmNvZGUgIT0gJ0VOT0VOVCcpIHRocm93IGVycm9yO1xyXG4gICAgICAgICAgICBpZiAoY29tbWVudCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coY29tbWVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG59Il19